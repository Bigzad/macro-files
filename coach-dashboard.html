<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Dashboard - Macro Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Supabase System -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="production-config.js"></script>
    <script src="supabase-init.js"></script>
    <script src="coach-auth-wrapper.js"></script>

    
    <!-- Notifications disabled -->
    
    <!-- Notifications system disabled -->

    
    <!-- Subscription Management System -->
    <script src="subscription-manager.js"></script>
    <script src="subscription-middleware.js"></script>
    
    <!-- Email System -->
    <script src="supabase-email-sender.js"></script>
    
    <style>
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.6); }
        }
        .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        
        .macro-progress {
            transition: all 0.3s ease;
        }
        
        .client-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .mobile-header {
                padding: 1rem;
            }
            
            .mobile-card {
                margin: 0.5rem;
                border-radius: 1rem;
            }
            
            .mobile-stats {
                padding: 1rem;
            }
            
            .mobile-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .mobile-text {
                font-size: 0.875rem;
                line-height: 1.25;
            }
            
            .client-card {
                margin-bottom: 1rem;
            }
            
            /* Report cards mobile fixes */
            .bg-white {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            /* Prevent horizontal scroll */
            body, html {
                overflow-x: hidden;
            }
            
            /* Grid container fixes */
            #reports-list, #shared-reports-list {
                width: 100%;
                overflow-x: hidden;
            }
        }
        
        /* Touch-friendly interactions */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        @media (hover: none) and (pointer: coarse) {
            .client-card:hover {
                transform: none;
            }
            
            .client-card:active {
                transform: scale(0.98);
                transition: transform 0.1s;
            }
        }

        /* Professional Notification System */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            width: 100%;
        }

        .notification {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            margin-bottom: 12px;
            padding: 16px 20px;
            border-left: 4px solid;
            transform: translateX(450px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.hide {
            transform: translateX(450px);
            opacity: 0;
        }

        .notification-icon {
            font-size: 20px;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            font-size: 15px;
            line-height: 1.3;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 14px;
            line-height: 1.4;
            color: #6b7280;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            margin-left: 8px;
            flex-shrink: 0;
            transition: color 0.2s;
        }

        .notification-close:hover {
            color: #374151;
        }

        /* Notification Types */
        .notification.error {
            border-left-color: #ef4444;
        }

        .notification.error .notification-icon {
            color: #ef4444;
        }

        .notification.success {
            border-left-color: #22c55e;
        }

        .notification.success .notification-icon {
            color: #22c55e;
        }

        .notification.info {
            border-left-color: #3b82f6;
        }

        .notification.info .notification-icon {
            color: #3b82f6;
        }

        .notification.warning {
            border-left-color: #f59e0b;
        }

        .notification.warning .notification-icon {
            color: #f59e0b;
        }

        /* Mobile responsive */
        @media (max-width: 640px) {
            .notification-container {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
            
            .notification {
                transform: translateY(-100px);
            }
            
            .notification.show {
                transform: translateY(0);
            }
            
            .notification.hide {
                transform: translateY(-100px);
            }
        }
        
        /* View Toggle Dropdown Styles */
        .dropdown-enter {
            transform: translateY(-10px);
            opacity: 0;
        }
        
        .dropdown-enter-active {
            transform: translateY(0);
            opacity: 1;
            transition: all 0.2s ease;
        }
        
        /* Improved mobile table scrolling */
        .mobile-table-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Unified admin/coach styling */
        .unified-view {
            transition: all 0.3s ease-in-out;
        }
        
        /* Progress Reports Styles */
        .tab-button.active {
            border-bottom-color: #2563eb;
            color: #2563eb;
        }
        
        .section-content {
            transition: all 0.3s ease-in-out;
        }
        
        .report-tab-button.active {
            border-bottom-color: #2563eb;
            color: #2563eb;
        }
        
        .report-card {
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }
        
        .report-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .report-status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-completed {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-generating {
            background-color: #dbeafe;
            color: #1d4ed8;
        }
        
        .status-failed {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .template-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .template-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        
        .template-card.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .chart-preview {
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-bottom: 1rem;
        }
        
        /* Modal z-index management */
        .z-60 {
            z-index: 60;
        }
        
        /* Report generation progress */
        .progress-bar {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            height: 4px;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        /* Report metrics display */
        .metric-card {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            line-height: 1;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        /* Responsive improvements for reports */
        @media (max-width: 768px) {
            .report-card {
                margin-bottom: 1rem;
            }
            
            .template-card {
                padding: 1rem;
            }
            
            .metric-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Professional Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Macro Adjustment Modal -->
    <div id="macro-adjustment-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full m-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <!-- Modal Header -->
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Adjust Client Macros</h3>
                    <button onclick="closeMacroAdjustmentModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- Client Info -->
                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                    <div class="text-sm font-medium text-gray-900" id="modal-client-name">Client Name</div>
                    <div class="text-xs text-gray-600" id="modal-client-email">client@email.com</div>
                </div>

                <!-- Current vs AI Comparison -->
                <div class="mb-4">
                    <div class="text-sm font-medium text-gray-700 mb-2">Current Target Source</div>
                    <div id="current-source-indicator" class="px-3 py-2 rounded-lg border">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>

                <!-- Macro Adjustment Form -->
                <form id="macro-adjustment-form" onsubmit="saveMacroAdjustments(event)">
                    <input type="hidden" id="modal-client-email-input" name="clientEmail">
                    
                    <!-- Calories -->
                    <div class="mb-4">
                        <label for="adjusted-calories" class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-fire text-orange-500 mr-1"></i>Daily Calories
                        </label>
                        <input type="number" 
                               id="adjusted-calories" 
                               name="calories" 
                               min="800" 
                               max="5000" 
                               step="50" 
                               required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <div class="text-xs text-gray-500 mt-1">Recommended: 1200-3500 calories</div>
                    </div>

                    <!-- Protein -->
                    <div class="mb-4">
                        <label for="adjusted-protein" class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-drumstick-bite text-red-500 mr-1"></i>Protein (grams)
                        </label>
                        <input type="number" 
                               id="adjusted-protein" 
                               name="protein" 
                               min="50" 
                               max="300" 
                               step="5" 
                               required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <div class="text-xs text-gray-500 mt-1">Recommended: 80-250g per day</div>
                    </div>

                    <!-- Carbohydrates -->
                    <div class="mb-4">
                        <label for="adjusted-carbs" class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-bread-slice text-yellow-600 mr-1"></i>Carbohydrates (grams)
                        </label>
                        <input type="number" 
                               id="adjusted-carbs" 
                               name="carbs" 
                               min="50" 
                               max="400" 
                               step="5" 
                               required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <div class="text-xs text-gray-500 mt-1">Recommended: 100-350g per day</div>
                    </div>

                    <!-- Fat -->
                    <div class="mb-4">
                        <label for="adjusted-fat" class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-cheese text-purple-600 mr-1"></i>Fat (grams)
                        </label>
                        <input type="number" 
                               id="adjusted-fat" 
                               name="fat" 
                               min="20" 
                               max="200" 
                               step="5" 
                               required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <div class="text-xs text-gray-500 mt-1">Recommended: 40-120g per day</div>
                    </div>

                    <!-- Adjustment Reason -->
                    <div class="mb-6">
                        <label for="adjustment-reason" class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-comment mr-1"></i>Reason for Adjustment (Optional)
                        </label>
                        <textarea id="adjustment-reason" 
                                  name="reason" 
                                  rows="3" 
                                  maxlength="200"
                                  placeholder="e.g., Increased calories for bulk phase, adjusted protein for strength goals"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        <div class="text-xs text-gray-500 mt-1">This helps track why changes were made</div>
                    </div>

                    <!-- Modal Actions -->
                    <div class="flex justify-between space-x-3">
                        <button type="button" 
                                onclick="revertToAIMacros()" 
                                class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition-colors">
                            <i class="fas fa-undo mr-1"></i>Revert to AI
                        </button>
                        <button type="button" 
                                onclick="closeMacroAdjustmentModal()" 
                                class="flex-1 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-1"></i>Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Report Modal -->
    <div id="create-report-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-chart-bar text-blue-600 mr-2"></i>Create Progress Report
                    </h3>
                    <button onclick="closeCreateReportModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="create-report-form" onsubmit="createProgressReport(event)">
                    <!-- Client Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Client</label>
                        <select id="report-client-select" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Choose a client...</option>
                        </select>
                    </div>

                    <!-- Report Type -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Report Type</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="relative">
                                <input type="radio" id="report-weekly" name="report-type" value="weekly" class="sr-only peer" checked>
                                <label for="report-weekly" class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer peer-checked:border-blue-600 peer-checked:bg-blue-50 hover:bg-gray-50">
                                    <i class="fas fa-calendar-week text-2xl text-gray-400 peer-checked:text-blue-600 mb-2"></i>
                                    <span class="text-sm font-medium">Weekly Report</span>
                                    <span class="text-xs text-gray-500 text-center">Last 7 days progress</span>
                                </label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="report-monthly" name="report-type" value="monthly" class="sr-only peer">
                                <label for="report-monthly" class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer peer-checked:border-blue-600 peer-checked:bg-blue-50 hover:bg-gray-50">
                                    <i class="fas fa-calendar-alt text-2xl text-gray-400 peer-checked:text-blue-600 mb-2"></i>
                                    <span class="text-sm font-medium">Monthly Report</span>
                                    <span class="text-xs text-gray-500 text-center">Last 30 days analysis</span>
                                </label>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="relative">
                                <input type="radio" id="report-custom" name="report-type" value="custom" class="sr-only peer">
                                <label for="report-custom" class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer peer-checked:border-blue-600 peer-checked:bg-blue-50 hover:bg-gray-50">
                                    <i class="fas fa-calendar text-xl text-gray-400 peer-checked:text-blue-600 mr-4"></i>
                                    <div>
                                        <span class="text-sm font-medium block">Custom Date Range</span>
                                        <span class="text-xs text-gray-500">Choose specific dates</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Date Range (Hidden by default) -->
                    <div id="custom-date-range" class="mb-6 hidden">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                                <input type="date" id="report-date-from" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                                <input type="date" id="report-date-to" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Template Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Report Template</label>
                        <select id="report-template-select" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Loading templates...</option>
                        </select>
                    </div>

                    <!-- Report Title -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Report Title</label>
                        <input type="text" id="report-title" placeholder="Auto-generated based on selection" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex space-x-4">
                        <button type="button" onclick="closeCreateReportModal()" 
                                class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-chart-bar mr-2"></i>Generate Report
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Report Details Modal -->
    <div id="report-details-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 xl:w-2/3 shadow-lg rounded-md bg-white max-h-screen overflow-y-auto">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 id="report-details-title" class="text-lg font-medium text-gray-900"></h3>
                        <p id="report-details-subtitle" class="text-sm text-gray-600"></p>
                    </div>
                    <button onclick="closeReportDetailsModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div id="report-details-content">
                    <!-- Report content will be populated here -->
                </div>

                <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
                    <div class="flex space-x-3">
                        <button id="download-report-btn" onclick="downloadReport()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>Download PDF
                        </button>
                        <button id="share-report-btn" onclick="showShareReportModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-share-alt mr-2"></i>Share Report
                        </button>
                    </div>
                    <button onclick="closeReportDetailsModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Report Modal -->
    <div id="share-report-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60 hidden">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-share-alt text-green-600 mr-2"></i>Share Report
                    </h3>
                    <button onclick="closeShareReportModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="share-report-form" onsubmit="shareReport(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Share with Email</label>
                        <input type="email" id="share-email" required 
                               placeholder="Enter recipient's email address"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div class="mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="share-download-allowed" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700">Allow recipient to download report</span>
                        </label>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Expiration (Optional)</label>
                        <select id="share-expiration" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Never expires</option>
                            <option value="24">24 hours</option>
                            <option value="168">1 week</option>
                            <option value="720">1 month</option>
                        </select>
                    </div>

                    <div class="flex space-x-4">
                        <button type="button" onclick="closeShareReportModal()" 
                                class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-share-alt mr-2"></i>Share Report
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Template Modal -->
    <div id="create-template-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-file-alt text-blue-600 mr-2"></i>Create Report Template
                    </h3>
                    <button onclick="closeCreateTemplateModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="create-template-form" onsubmit="createReportTemplate(event)">
                    <!-- Template Name -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Template Name</label>
                        <input type="text" id="template-name" required 
                               placeholder="Enter template name (e.g., 'Weekly Check-in', 'Monthly Assessment')"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Template Description -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="template-description" rows="3" 
                                  placeholder="Brief description of when to use this template"
                                  class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>

                    <!-- Report Type -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Report Type</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="relative">
                                <input type="radio" id="template-weekly" name="template-type" value="weekly" class="sr-only peer" checked>
                                <label for="template-weekly" class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer peer-checked:border-blue-600 peer-checked:bg-blue-50 hover:bg-gray-50">
                                    <i class="fas fa-calendar-week text-2xl text-gray-400 peer-checked:text-blue-600 mb-2"></i>
                                    <span class="text-sm font-medium">Weekly</span>
                                </label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="template-monthly" name="template-type" value="monthly" class="sr-only peer">
                                <label for="template-monthly" class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer peer-checked:border-blue-600 peer-checked:bg-blue-50 hover:bg-gray-50">
                                    <i class="fas fa-calendar-alt text-2xl text-gray-400 peer-checked:text-blue-600 mb-2"></i>
                                    <span class="text-sm font-medium">Monthly</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Metrics to Include -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Metrics to Include</label>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex items-center">
                                <input type="checkbox" name="template-metrics" value="weight" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Weight Progress</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="template-metrics" value="macros" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Macro Adherence</span>
                            </label>
                            <label class="flex items-center opacity-50 cursor-not-allowed" onclick="showComingSoonNotification('Workout Completion')">
                                <input type="checkbox" name="template-metrics" value="workouts" disabled class="rounded border-gray-300 text-gray-400 cursor-not-allowed">
                                <span class="ml-2 text-sm text-gray-500">Workout Completion <span class="text-xs text-blue-500">(Coming Soon)</span></span>
                            </label>
                            <label class="flex items-center opacity-50 cursor-not-allowed" onclick="showComingSoonNotification('Sleep Quality')">
                                <input type="checkbox" name="template-metrics" value="sleep" disabled class="rounded border-gray-300 text-gray-400 cursor-not-allowed">
                                <span class="ml-2 text-sm text-gray-500">Sleep Quality <span class="text-xs text-blue-500">(Coming Soon)</span></span>
                            </label>
                            <label class="flex items-center opacity-50 cursor-not-allowed" onclick="showComingSoonNotification('Energy Levels')">
                                <input type="checkbox" name="template-metrics" value="energy" disabled class="rounded border-gray-300 text-gray-400 cursor-not-allowed">
                                <span class="ml-2 text-sm text-gray-500">Energy Levels <span class="text-xs text-blue-500">(Coming Soon)</span></span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="template-metrics" value="notes" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Coach Notes</span>
                            </label>
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button type="button" onclick="closeCreateTemplateModal()" 
                                class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>Create Template
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4"></div>
            <h2 class="text-xl font-semibold mb-2">Loading Dashboard...</h2>
            <p class="text-blue-100">Please wait while we initialize your coach dashboard</p>
        </div>
    </div>

    <!-- Authentication Check -->
    <div id="auth-check" class="hidden fixed inset-0 bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="inline-block p-3 bg-red-100 rounded-full mb-4">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                </div>
                <h2 class="text-xl font-semibold text-gray-900 mb-2">Authentication Required</h2>
                <p class="text-gray-600 mb-6">You need to be logged in as a coach to access this dashboard.</p>
                
                <!-- Auth Loading -->
                <div id="auth-loading" class="hidden mb-4">
                    <div class="animate-spin inline-block w-6 h-6 border-[3px] border-current border-t-transparent text-blue-600 rounded-full"></div>
                    <p class="text-sm text-gray-600 mt-2">Authenticating...</p>
                </div>
                
                <!-- Auth Error -->
                <div id="auth-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                    <p class="text-red-700 text-sm">Authentication failed. Please try again.</p>
                </div>
                
                <!-- Auth Actions -->
                <div id="auth-actions" class="space-y-3">
                    <button onclick="window.location.href='coach-login.html'" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        Go to Coach Login
                    </button>
                    <button onclick="window.location.href='index.html'" class="w-full bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        <i class="fas fa-home mr-2"></i>
                        Back to Home
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 sm:py-4 mobile-header">
                <div class="flex justify-between items-center">
                    <div class="flex-1 min-w-0">
                        <h1 class="text-xl sm:text-2xl font-bold text-gray-900 truncate">
                            <i class="fas fa-dumbbell text-blue-600 mr-2 sm:mr-3"></i>
                            <span id="coach-title" class="hidden sm:inline">Coach Dashboard</span>
                            <span id="coach-title-mobile" class="sm:hidden">Coach</span>
                        </h1>
                        <p class="text-gray-600 mt-1 text-sm hidden sm:block">Monitor your clients' macro nutrition progress</p>
                    </div>
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <div class="text-right hidden sm:block">
                            <div class="text-sm font-medium text-gray-900" id="coach-name">Coach</div>
                            <div class="text-xs text-gray-600" id="coach-email"></div>
                        </div>

                            
                            <button onclick="openSettingsModal()" class="bg-gray-600 text-white px-3 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm touch-target mr-2">
                                <i class="fas fa-cog"></i>
                                <span class="hidden sm:inline ml-2">Settings</span>
                            </button>
                            <button onclick="coachLogout()" class="bg-red-600 text-white px-3 py-2 sm:px-4 rounded-lg hover:bg-red-700 transition-colors text-sm sm:text-base touch-target">
                                <i class="fas fa-sign-out-alt mr-1 sm:mr-2"></i>
                                <span class="hidden sm:inline">Logout</span>
                                <span class="sm:hidden">Exit</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile coach info -->
                <div class="mt-2 sm:hidden">
                    <div class="text-xs font-medium text-gray-900" id="coach-name-mobile"></div>
                    <div class="text-xs text-gray-600" id="coach-email-mobile"></div>
                </div>
            </div>
        </header>

        <!-- Coach Stats Overview -->
        <div id="coach-view" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6">
            <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6 mb-6 sm:mb-8">
                <div class="bg-white rounded-lg shadow p-3 sm:p-6 mobile-stats">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 bg-blue-100 rounded-full flex-shrink-0">
                            <i class="fas fa-users text-blue-600 text-sm sm:text-xl"></i>
                        </div>
                        <div class="ml-2 sm:ml-4 min-w-0 flex-1">
                            <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">My Clients</p>
                            <p id="stat-client-count" class="text-lg sm:text-2xl font-bold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-3 sm:p-6 mobile-stats">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 bg-green-100 rounded-full flex-shrink-0">
                            <i class="fas fa-bullseye text-green-600 text-sm sm:text-xl"></i>
                        </div>
                        <div class="ml-2 sm:ml-4 min-w-0 flex-1">
                            <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">On Track</p>
                            <p id="stat-on-track" class="text-lg sm:text-2xl font-bold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-3 sm:p-6 mobile-stats col-span-2 sm:col-span-1">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 bg-yellow-100 rounded-full flex-shrink-0">
                            <i class="fas fa-utensils text-yellow-600 text-sm sm:text-xl"></i>
                        </div>
                        <div class="ml-2 sm:ml-4 min-w-0 flex-1">
                            <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">Meals Today</p>
                            <p id="stat-meals-today" class="text-lg sm:text-2xl font-bold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-3 sm:p-6 mobile-stats col-span-2 sm:col-span-1">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 bg-purple-100 rounded-full flex-shrink-0">
                            <i class="fas fa-chart-line text-purple-600 text-sm sm:text-xl"></i>
                        </div>
                        <div class="ml-2 sm:ml-4 min-w-0 flex-1">
                            <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">Avg. Adherence</p>
                            <p id="stat-avg-adherence" class="text-lg sm:text-2xl font-bold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="bg-white rounded-lg shadow mb-6">
                <nav class="flex" aria-label="Tabs">
                    <button id="clients-tab" onclick="showSection('clients')" 
                            class="tab-button flex-1 py-4 px-1 text-center border-b-2 border-blue-500 font-medium text-sm text-blue-600 whitespace-nowrap">
                        <i class="fas fa-users mr-2"></i>
                        <span class="hidden sm:inline">Client Management</span>
                        <span class="sm:hidden">Clients</span>
                    </button>
                    <button id="reports-tab" onclick="showSection('reports')" 
                            class="tab-button flex-1 py-4 px-1 text-center border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                        <i class="fas fa-chart-bar mr-2"></i>
                        <span class="hidden sm:inline">Progress Reports</span>
                        <span class="sm:hidden">Reports</span>
                    </button>
                </nav>
            </div>

            <!-- Client Management Section -->
            <div id="clients-section" class="section-content">
                <!-- Date Filter -->
                <div class="bg-white rounded-lg shadow mb-4 sm:mb-6 p-4 sm:p-6">
                <div class="flex flex-col space-y-4 sm:flex-row sm:items-center sm:justify-between sm:space-y-0">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <h3 class="text-lg font-medium text-gray-900">Client Macro Progress</h3>
                        <div class="text-xs text-gray-500 mt-1 sm:mt-0">
                            Last updated: <span id="last-update-time">Loading...</span>
                        </div>
                    </div>
                    <div class="flex flex-col space-y-3 sm:space-y-0 sm:flex-row sm:items-center sm:space-x-4">
                        <div class="flex items-center">
                            <label for="date-filter" class="text-sm text-gray-600 mr-2 whitespace-nowrap">Date:</label>
                            <input type="date" id="date-filter" 
                                   class="flex-1 sm:flex-none border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-target"
                                   onchange="filterByDate()">
                        </div>
                        <button id="refresh-button" onclick="refreshClients()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm touch-target disabled:opacity-50 disabled:cursor-not-allowed">
                            <i id="refresh-icon" class="fas fa-sync-alt mr-2"></i>
                            <span id="refresh-text-full" class="hidden sm:inline">Refresh Data</span>
                            <span id="refresh-text-short" class="sm:hidden">Refresh</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading" class="text-center py-12">
                <div class="animate-spin inline-block w-8 h-8 border-[3px] border-current border-t-transparent text-blue-600 rounded-full mb-4"></div>
                <p class="text-gray-600">Loading client data...</p>
            </div>



            <!-- Daily Progress Overview -->
            <div id="progress-overview-container" class="hidden mb-6">
                <div class="bg-white rounded-lg shadow p-4 sm:p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">
                            <i class="fas fa-chart-pie text-blue-600 mr-2"></i>Today's Progress Overview
                        </h3>
                        <div class="text-sm text-gray-500" id="progress-date">
                            <!-- Current date will be displayed here -->
                        </div>
                    </div>
                    <div id="progress-summary" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <!-- Progress summary cards will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Clients Grid -->
            <div id="clients-container" class="hidden">
                <div id="clients-grid" class="grid grid-cols-1 sm:grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4 sm:gap-6 mobile-grid">
                    <!-- Client cards will be populated here -->
                </div>
            </div>

            <!-- No Clients State -->
            <div id="no-clients-state" class="hidden bg-white rounded-lg shadow p-8 text-center">
                <div class="inline-block p-3 bg-gray-100 rounded-full mb-4">
                    <i class="fas fa-users text-2xl text-gray-400"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No Clients Assigned</h3>
                <p class="text-gray-600">You don't have any clients assigned to you yet. Contact your admin to get started.</p>
            </div>
            </div>

            <!-- Progress Reports Section -->
            <div id="reports-section" class="section-content hidden">
                
                <!-- Report Generation Header -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg shadow mb-6 text-white p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <div>
                            <h2 class="text-2xl font-bold mb-2">Progress Reports</h2>
                            <p class="text-blue-100">Generate comprehensive client progress reports with visual analytics</p>
                        </div>
                        <div class="mt-4 sm:mt-0">
                            <button onclick="showCreateReportModal()" class="bg-white text-blue-600 px-6 py-3 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                                <i class="fas fa-plus mr-2"></i>
                                Create Report
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-green-100 rounded-full">
                                <i class="fas fa-file-alt text-green-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Reports</p>
                                <p id="stat-total-reports" class="text-2xl font-bold text-gray-900">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-blue-100 rounded-full">
                                <i class="fas fa-download text-blue-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">This Month</p>
                                <p id="stat-monthly-reports" class="text-2xl font-bold text-gray-900">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-purple-100 rounded-full">
                                <i class="fas fa-share-alt text-purple-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Shared Reports</p>
                                <p id="stat-shared-reports" class="text-2xl font-bold text-gray-900">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Report Management Tabs -->
                <div class="bg-white rounded-lg shadow mb-6">
                    <nav class="flex border-b border-gray-200" aria-label="Report tabs">
                        <button id="my-reports-tab" onclick="showReportTab('my-reports')" 
                                class="report-tab-button flex-1 py-4 px-1 text-center border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                            <i class="fas fa-folder mr-2"></i>My Reports
                        </button>
                        <button id="templates-tab" onclick="showReportTab('templates')" 
                                class="report-tab-button flex-1 py-4 px-1 text-center border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            <i class="fas fa-file-invoice mr-2"></i>Templates
                        </button>
                        <button id="shared-tab" onclick="showReportTab('shared')" 
                                class="report-tab-button flex-1 py-4 px-1 text-center border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            <i class="fas fa-users mr-2"></i>Shared Reports
                        </button>
                    </nav>
                </div>

                <!-- My Reports Tab Content -->
                <div id="my-reports-content" class="report-tab-content">
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                <h3 class="text-lg font-medium text-gray-900">Generated Reports</h3>
                                <div class="mt-3 sm:mt-0 flex flex-col sm:flex-row gap-3">
                                    <select id="report-status-filter" onchange="filterReports()" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                                        <option value="">All Status</option>
                                        <option value="completed">Completed</option>
                                        <option value="generating">Generating</option>
                                        <option value="failed">Failed</option>
                                    </select>
                                    <select id="report-type-filter" onchange="filterReports()" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                                        <option value="">All Types</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="reports-list" class="p-3 sm:p-4 md:p-6 grid gap-3 sm:gap-4 grid-cols-1 md:grid-cols-2 xl:grid-cols-3">
                            <!-- Reports will be populated here -->
                        </div>
                        <div id="no-reports-state" class="hidden p-12 text-center">
                            <div class="inline-block p-3 bg-gray-100 rounded-full mb-4">
                                <i class="fas fa-file-alt text-2xl text-gray-400"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No Reports Generated</h3>
                            <p class="text-gray-600 mb-4">Create your first progress report to get started.</p>
                            <button onclick="showCreateReportModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-plus mr-2"></i>Create First Report
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Templates Tab Content -->
                <div id="templates-content" class="report-tab-content hidden">
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                <h3 class="text-lg font-medium text-gray-900">Report Templates</h3>
                                <button onclick="showCreateTemplateModal()" class="mt-3 sm:mt-0 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                    <i class="fas fa-plus mr-2"></i>Create Template
                                </button>
                            </div>
                        </div>
                        <div id="templates-grid" class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <!-- Templates will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shared Reports Tab Content -->
                <div id="shared-content" class="report-tab-content hidden">
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">Shared Reports Management</h3>
                        </div>
                        <div id="shared-reports-list" class="p-3 sm:p-4 md:p-6 grid gap-3 sm:gap-4 grid-cols-1 md:grid-cols-2 xl:grid-cols-3">
                            <!-- Shared reports will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        

    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center text-sm">
                <div class="mb-4 md:mb-0">
                    <p class="text-gray-300">&copy; 2024 Macro Calculator - Coach Dashboard</p>
                </div>
                <div class="flex items-center space-x-6">
                    <a href="index.html" class="text-blue-400 hover:text-blue-300 transition-colors flex items-center">
                        <i class="fas fa-home mr-2"></i>Main App
                    </a>
                    <span class="text-gray-400">|</span>
                    <span class="text-gray-300">Coach Portal</span>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Coach Dashboard - Pure UI Logic (No Authentication)
        
        // Dashboard variables  
        let clientsData = [];
        let selectedDate = new Date().toISOString().split('T')[0];
        let isLoadingDashboard = false;
        
        // Progress Reports variables
        let currentReports = [];
        let currentTemplates = [];
        let currentSharedReports = [];
        let selectedReportId = null;

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            // Prevent duplicate initialization
            if (window.dashboardInitialized) {
                console.log('Dashboard already initialized via auth system, skipping...');
                return;
            }
            await initializeDashboard();
            await initializeLogoFeatures();
        });

        // Initialize dashboard
        async function initializeDashboard() {
            console.log('🚀 Initializing Coach Dashboard...');
            
            // Mark as initialized to prevent conflicts
            window.dashboardInitialized = true;
            
            // Protect dashboard - redirect if not authenticated
            const isProtected = await window.coachAuthWrapper.protectCoachDashboard();
            if (!isProtected) {
                return; // Will redirect to login
            }
            
            // Get coach info for UI updates
            const coachInfo = window.coachAuthWrapper.getCurrentCoach();
            if (coachInfo.isAuthenticated) {
                // Set up global variables for compatibility
                window.currentUser = coachInfo.user;
                window.currentUserRole = {
                    role: coachInfo.role,
                    display_name: coachInfo.user?.email || 'Coach',
                    permissions: {},
                    can_manage_users: ['admin', 'owner'].includes(coachInfo.role),
                    can_access_analytics: ['admin', 'owner', 'coach'].includes(coachInfo.role),
                    can_generate_codes: ['admin', 'owner'].includes(coachInfo.role)
                };
            }
            
            // Hide loading screen and show dashboard
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Initialize date filter
            document.getElementById('date-filter').value = selectedDate;
            
            // Update coach info in header (use existing coachInfo)
            if (window.currentUser) {
                const coachDisplayName = window.currentUserRole?.display_name || window.currentUser.email || 'Coach';
                document.getElementById('coach-name').textContent = coachDisplayName;
                document.getElementById('coach-name-mobile').textContent = coachDisplayName;
                document.getElementById('coach-email').textContent = window.currentUser.email;
            }
            
            // Load dashboard content
            await loadDashboardContent();
        }

        // Logout function
        async function coachLogout() {
            await window.coachAuthWrapper.coachLogout();
        }

        // Old authentication functions removed - using coach-auth-wrapper.js now

        // Data fetching functions
        async function fetchAssignedClients() {
            try {
                if (!window.supabaseClient) {
                    throw new Error('Supabase client not available');
                }

                let query = window.supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                // Apply coach filtering - coaches only see their assigned clients
                let coachInfo = window.coachAuthWrapper.getCurrentCoach();
                if (coachInfo.isAuthenticated) {
                    query = query.eq('assigned_coach', coachInfo.email);
                }
                
                const { data, error } = await query;
                
                if (error) {
                    throw error;
                }
                
                return data || [];
                
            } catch (error) {
                throw error;
            }
        }

        async function fetchClientMacrosForDate(clientEmail, date) {
            try {
                
                // Fetch daily meals for the specific date
                const { data: mealsData, error: mealsError } = await window.supabaseClient
                    .from('daily_meals')
                    .select('*')
                    .eq('user_email', clientEmail)
                    .gte('created_at', date + 'T00:00:00')
                    .lt('created_at', date + 'T23:59:59');
                
                if (mealsError) {
                    return null;
                }

                // Step 1: Always get the latest AI-generated macros first
                const { data: latestAITargets, error: aiTargetsError } = await window.supabaseClient
                    .from('daily_targets')
                    .select('*')
                    .eq('user_email', clientEmail)
                    .order('updated_at', { ascending: false }) // Order by updated_at to get the most recent
                    .limit(1);

                // Step 2: Check for coach adjustments
                const { data: coachAdjustments, error: adjustError } = await window.supabaseClient
                    .from('coach_macro_adjustments')
                    .select('*')
                    .eq('client_email', clientEmail)
                    .order('updated_at', { ascending: false })
                    .limit(1);

                let targets;
                let macroSource = 'ai_generated';
                let adjustedBy = null;
                let adjustmentReason = null;

                // Step 3: Determine which macros to use (coach adjustments take priority)
                if (!adjustError && coachAdjustments && coachAdjustments.length > 0) {
                    // Use coach-adjusted macros if they exist
                    const adjustment = coachAdjustments[0];
                    targets = {
                        calories: parseFloat(adjustment.adjusted_calories) || 2000,
                        protein: parseFloat(adjustment.adjusted_protein) || 150,
                        carbs: parseFloat(adjustment.adjusted_carbs) || 200,
                        fat: parseFloat(adjustment.adjusted_fat) || 65
                    };
                    macroSource = 'coach_adjusted';
                    adjustedBy = adjustment.coach_email;
                    adjustmentReason = adjustment.adjustment_reason;
                } else if (!aiTargetsError && latestAITargets && latestAITargets.length > 0) {
                    // Use latest AI-generated macros
                    const aiTarget = latestAITargets[0];
                    targets = {
                        calories: parseFloat(aiTarget.daily_calories) || 2000,
                        protein: parseFloat(aiTarget.daily_protein) || 150,
                        carbs: parseFloat(aiTarget.daily_carbs) || 200,
                        fat: parseFloat(aiTarget.daily_fat) || 65
                    };
                    macroSource = 'ai_generated';
                } else {
                    // Fallback to default values if no data found
                    targets = { calories: 2000, protein: 150, carbs: 200, fat: 65 };
                    macroSource = 'default';
                }

                console.log('📊 Fetched macros for', clientEmail, ':', {
                    targets,
                    macroSource,
                    aiTargetsFound: latestAITargets?.length || 0,
                    coachAdjustmentsFound: coachAdjustments?.length || 0
                });

                // Calculate totals from meals
                const macroTotals = (mealsData || []).reduce((totals, meal) => {
                    return {
                        calories: totals.calories + (parseFloat(meal.calories) || 0),
                        protein: totals.protein + (parseFloat(meal.protein) || 0),
                        carbs: totals.carbs + (parseFloat(meal.carbs) || 0),
                        fat: totals.fat + (parseFloat(meal.fat) || 0)
                    };
                }, { calories: 0, protein: 0, carbs: 0, fat: 0 });

                return {
                    consumed: macroTotals,
                    targets: targets,
                    macroSource: macroSource, // 'coach_adjusted', 'ai_generated', or 'default'
                    adjustedBy: adjustedBy,
                    adjustmentReason: adjustmentReason,
                    mealsCount: mealsData ? mealsData.length : 0
                };
                
            } catch (error) {
                return null;
            }
        }

        // Main dashboard load function
        async function loadDashboardContent() {
            // Prevent concurrent loading attempts
            if (isLoadingDashboard) {
                console.log('📊 Dashboard loading already in progress, skipping...');
                return;
            }
            
            isLoadingDashboard = true;
            
            // Add timeout safety mechanism to prevent infinite loading
            const loadingTimeout = setTimeout(() => {
                console.error('🚨 Dashboard loading timeout - forcing reset!');
                isLoadingDashboard = false;
                showError('Loading Timeout', 'Dashboard loading took too long and was reset. Please try refreshing.');
                
                // Reset UI state on timeout
                const timeoutElements = {
                    loading: document.getElementById('loading'),
                    clientsContainer: document.getElementById('clients-container')
                };
                if (timeoutElements.loading) timeoutElements.loading.classList.add('hidden');
                if (timeoutElements.clientsContainer) timeoutElements.clientsContainer.classList.remove('hidden');
            }, 30000); // 30 second timeout
            
            // Helper function to safely get elements
            const getLoadingElements = () => {
                return {
                    loading: document.getElementById('loading'),
                    clientsContainer: document.getElementById('clients-container'),
                    noClientsState: document.getElementById('no-clients-state')
                };
            };
            
            try {
                console.log('📊 Loading coach dashboard content...');
                console.log('🔄 Current loading state - isLoadingDashboard:', isLoadingDashboard);
                console.log('📍 Called from:', (new Error()).stack.split('\n')[2].trim());
                
                // Reset UI state
                const elements = getLoadingElements();
                
                if (elements.loading) elements.loading.classList.remove('hidden');
                if (elements.clientsContainer) elements.clientsContainer.classList.add('hidden');
                if (elements.noClientsState) elements.noClientsState.classList.add('hidden');

                // Get current coach info
                let coachInfo = window.coachAuthWrapper.getCurrentCoach();
                
                // Update coach info in header
                if (coachInfo.isAuthenticated) {
                    const coachDisplayName = window.currentUserRole?.display_name || coachInfo.email || 'Coach';
                    document.getElementById('coach-title').textContent = 'Coach Dashboard';
                    document.getElementById('coach-title-mobile').textContent = 'Coach';
                    document.getElementById('coach-name').textContent = coachDisplayName;
                    document.getElementById('coach-name-mobile').textContent = coachDisplayName;
                    document.getElementById('coach-email').textContent = coachInfo.email;
                }

                // Fetch assigned clients
                const clients = await fetchAssignedClients();
                
                if (clients.length === 0) {
                    console.log('📭 No clients found');
                    const elements = getLoadingElements();
                    if (elements.loading) elements.loading.classList.add('hidden');
                    if (elements.noClientsState) elements.noClientsState.classList.remove('hidden');
                    
                    updateStats([], []);
                    
                    // Update timestamp even when no clients
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    const lastUpdateElement = document.getElementById('last-update-time');
                    if (lastUpdateElement) {
                        lastUpdateElement.textContent = timeString;
                    }
                    
                    // Hide auth screen and show dashboard even when no clients
                    document.getElementById('auth-check').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    
                    console.log('✅ Dashboard loaded (no clients case)');
                    return;
                }

                clientsData = clients;

                // Fetch macro data for each client
                const clientsWithMacros = [];
                for (const client of clients) {
                    const clientEmail = client.user_email || client.email;
                    if (clientEmail) {
                        const macroData = await fetchClientMacrosForDate(clientEmail, selectedDate);
                        clientsWithMacros.push({
                            ...client,
                            macros: macroData
                        });
                    }
                }

                displayClients(clientsWithMacros);
                updateStats(clients, clientsWithMacros);
                
                // Update last refresh timestamp
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                const lastUpdateElement = document.getElementById('last-update-time');
                if (lastUpdateElement) {
                    lastUpdateElement.textContent = timeString;
                }



                // Hide loading and show clients container
                const elements2 = getLoadingElements();
                if (elements2.loading) elements2.loading.classList.add('hidden');
                if (elements2.clientsContainer) elements2.clientsContainer.classList.remove('hidden');
                
                // Hide auth screen and show dashboard
                document.getElementById('auth-check').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');

            } catch (error) {
                console.error('❌ Failed to load coach dashboard:', error);
                showError('Dashboard Load Error', 'Failed to load coach dashboard: ' + error.message);
                
                // Reset UI state on error
                const elementsError = getLoadingElements();
                if (elementsError.loading) elementsError.loading.classList.add('hidden');
                if (elementsError.clientsContainer) elementsError.clientsContainer.classList.remove('hidden');
                
                // Ensure dashboard is visible even on error
                document.getElementById('auth-check').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
            } finally {
                // Clear the timeout
                clearTimeout(loadingTimeout);
                
                // Always reset loading state
                isLoadingDashboard = false;
                
                // Ensure loading elements are hidden
                const elementsFinal = getLoadingElements();
                if (elementsFinal.loading) elementsFinal.loading.classList.add('hidden');
                
                console.log('📊 Dashboard loading completed - isLoadingDashboard set to false');
            }
        }

        function displayClients(clientsWithMacros) {
            const grid = document.getElementById('clients-grid');
            grid.innerHTML = '';

            if (clientsWithMacros.length === 0) {
                document.getElementById('clients-container').classList.add('hidden');
                document.getElementById('no-clients-state').classList.remove('hidden');
                document.getElementById('progress-overview-container').classList.add('hidden');
                return;
            }

            document.getElementById('clients-container').classList.remove('hidden');
            document.getElementById('no-clients-state').classList.add('hidden');
            
            // Show and populate progress overview
            displayProgressOverview(clientsWithMacros);

            clientsWithMacros.forEach(client => {
                const card = createClientCard(client);
                grid.appendChild(card);
            });
        }

        function displayProgressOverview(clientsWithMacros) {
            const overviewContainer = document.getElementById('progress-overview-container');
            const progressSummary = document.getElementById('progress-summary');
            const progressDate = document.getElementById('progress-date');
            
            // Set current date
            const currentDate = new Date(selectedDate);
            progressDate.textContent = currentDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            // Calculate overall statistics
            let totalClients = 0;
            let excellentProgress = 0; // >= 90%
            let goodProgress = 0; // 70-89%
            let needsAttention = 0; // < 70%
            let totalAdherence = 0;

            clientsWithMacros.forEach(client => {
                if (client.macros) {
                    const { consumed, targets } = client.macros;
                    
                    // Calculate adherence
                    const caloriesPercent = Math.min((consumed.calories / targets.calories) * 100, 100);
                    const proteinPercent = Math.min((consumed.protein / targets.protein) * 100, 100);
                    const carbsPercent = Math.min((consumed.carbs / targets.carbs) * 100, 100);
                    const fatPercent = Math.min((consumed.fat / targets.fat) * 100, 100);
                    const adherence = Math.round((caloriesPercent + proteinPercent + carbsPercent + fatPercent) / 4);
                    
                    totalClients++;
                    totalAdherence += adherence;
                    
                    if (adherence >= 90) excellentProgress++;
                    else if (adherence >= 70) goodProgress++;
                    else needsAttention++;
                }
            });

            const avgAdherence = totalClients > 0 ? Math.round(totalAdherence / totalClients) : 0;

            // Create progress summary cards
            progressSummary.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-green-600 mb-1">${excellentProgress}</div>
                    <div class="text-sm text-green-700 font-medium">Excellent</div>
                    <div class="text-xs text-green-600">≥90% Progress</div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-yellow-600 mb-1">${goodProgress}</div>
                    <div class="text-sm text-yellow-700 font-medium">Good</div>
                    <div class="text-xs text-yellow-600">70-89% Progress</div>
                </div>
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-red-600 mb-1">${needsAttention}</div>
                    <div class="text-sm text-red-700 font-medium">Needs Focus</div>
                    <div class="text-xs text-red-600">&lt;70% Progress</div>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-blue-600 mb-1">${avgAdherence}%</div>
                    <div class="text-sm text-blue-700 font-medium">Avg Progress</div>
                    <div class="text-xs text-blue-600">Overall Team</div>
                </div>
            `;

            overviewContainer.classList.remove('hidden');
        }

        function createClientCard(client) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow client-card transition-all duration-300 p-6';
            
            const clientName = client.user_name || 'Unknown User';
            const clientEmail = client.user_email || client.email || 'no-email';
            const macros = client.macros;
            const cardId = `client-${clientEmail.replace(/[^a-zA-Z0-9]/g, '')}-${Date.now()}`;
            
            if (!macros) {
                div.innerHTML = `
                    <div class="text-center py-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${clientName}</h3>
                        <div class="text-gray-500">
                            <i class="fas fa-exclamation-circle mb-2"></i>
                            <p>No data available</p>
                        </div>
                    </div>
                `;
                return div;
            }

            const { consumed, targets, mealsCount } = macros;
            
            // Calculate percentages
            const caloriesPercent = Math.min((consumed.calories / targets.calories) * 100, 100);
            const proteinPercent = Math.min((consumed.protein / targets.protein) * 100, 100);
            const carbsPercent = Math.min((consumed.carbs / targets.carbs) * 100, 100);
            const fatPercent = Math.min((consumed.fat / targets.fat) * 100, 100);
            
            // Calculate adherence score
            const adherence = Math.round((caloriesPercent + proteinPercent + carbsPercent + fatPercent) / 4);
            const adherenceColor = adherence >= 80 ? 'text-green-600' : adherence >= 60 ? 'text-yellow-600' : 'text-red-600';
            const adherenceBg = adherence >= 80 ? 'bg-green-100' : adherence >= 60 ? 'bg-yellow-100' : 'bg-red-100';

            // Determine progress indicator colors based on adherence level
            let progressBg, progressText, progressBorder;
            if (adherence >= 90) {
                progressBg = 'bg-green-50';
                progressText = 'text-green-700';
                progressBorder = 'border-green-200';
            } else if (adherence >= 70) {
                progressBg = 'bg-yellow-50';
                progressText = 'text-yellow-700';
                progressBorder = 'border-yellow-200';
            } else if (adherence >= 50) {
                progressBg = 'bg-blue-50';
                progressText = 'text-blue-700';
                progressBorder = 'border-blue-200';
            } else {
                progressBg = 'bg-red-50';
                progressText = 'text-red-700';
                progressBorder = 'border-red-200';
            }

            div.innerHTML = `
                <!-- Daily Progress Indicator -->
                <div class="flex justify-center mb-4">
                    <div class="${progressBg} border ${progressBorder} rounded-full px-4 py-2">
                        <span class="${progressText} font-medium text-sm">
                            <i class="fas fa-target mr-1"></i>Daily Progress: 
                            <span class="font-bold">${adherence}%</span>
                        </span>
                    </div>
                </div>

                <!-- Client Header (Always Visible) -->
                <div class="cursor-pointer" onclick="toggleClientDetails('${cardId}')">
                    <div class="flex items-start justify-between mb-4">
                        <div class="min-w-0 flex-1">
                            <h3 class="text-base sm:text-lg font-semibold text-gray-900 truncate">${clientName}</h3>
                        </div>
                        <div class="text-center flex-shrink-0 ml-3">
                            <div class="px-2 sm:px-3 py-1 rounded-full ${adherenceBg} ${adherenceColor} text-xs sm:text-sm font-medium">
                                ${adherence}%
                            </div>
                            <p class="text-xs text-gray-500 mt-1 hidden sm:block">Adherence</p>
                        </div>
                    </div>
                    
                    <!-- Quick Summary (Always Visible) -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4 text-xs sm:text-sm text-gray-600">
                            <span><i class="fas fa-fire text-orange-500 mr-1"></i>${Math.round(consumed.calories)}cal</span>
                            <span><i class="fas fa-drumstick-bite text-red-500 mr-1"></i>${Math.round(consumed.protein)}g</span>
                            <span><i class="fas fa-utensils text-gray-400 mr-1"></i>${mealsCount} meals</span>
                        </div>
                        <div class="flex items-center">
                            <i id="toggle-icon-${cardId}" class="fas fa-chevron-down text-gray-400 transform transition-transform duration-200"></i>
                            <span class="ml-2 text-xs text-gray-500">Details</span>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Macro Data (Collapsible) -->
                <div id="details-${cardId}" class="hidden mt-4 pt-4 border-t border-gray-200">
                    <div class="space-y-3">
                        <!-- Calories -->
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-700">
                                    <i class="fas fa-fire text-orange-500 mr-2"></i>Calories
                                </span>
                                <span class="text-sm text-gray-600">${Math.round(consumed.calories)} / ${Math.round(targets.calories)}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-orange-600 h-2.5 rounded-full macro-progress transition-all duration-300" style="width: ${caloriesPercent}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">${caloriesPercent.toFixed(1)}% of goal</div>
                        </div>
                        
                        <!-- Protein -->
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-700">
                                    <i class="fas fa-drumstick-bite text-red-500 mr-2"></i>Protein
                                </span>
                                <span class="text-sm text-gray-600">${Math.round(consumed.protein)}g / ${Math.round(targets.protein)}g</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-red-600 h-2.5 rounded-full macro-progress transition-all duration-300" style="width: ${proteinPercent}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">${proteinPercent.toFixed(1)}% of goal</div>
                        </div>
                        
                        <!-- Carbs -->
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-700">
                                    <i class="fas fa-bread-slice text-yellow-600 mr-2"></i>Carbs
                                </span>
                                <span class="text-sm text-gray-600">${Math.round(consumed.carbs)}g / ${Math.round(targets.carbs)}g</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-yellow-600 h-2.5 rounded-full macro-progress transition-all duration-300" style="width: ${carbsPercent}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">${carbsPercent.toFixed(1)}% of goal</div>
                        </div>
                        
                        <!-- Fat -->
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-700">
                                    <i class="fas fa-cheese text-purple-600 mr-2"></i>Fat
                                </span>
                                <span class="text-sm text-gray-600">${Math.round(consumed.fat)}g / ${Math.round(targets.fat)}g</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-purple-600 h-2.5 rounded-full macro-progress transition-all duration-300" style="width: ${fatPercent}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">${fatPercent.toFixed(1)}% of goal</div>
                        </div>
                    </div>
                    
                    <!-- Macro Source Indicator -->
                    ${macros.macroSource === 'coach_adjusted' ? `
                    <div class="mt-2 px-3 py-1 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center text-xs text-blue-700">
                            <i class="fas fa-user-cog mr-1"></i>
                            <span class="font-medium">Coach Adjusted</span>
                            ${macros.adjustmentReason ? `<span class="ml-1">- ${macros.adjustmentReason}</span>` : ''}
                        </div>
                    </div>
                    ` : `
                    <div class="mt-2 px-3 py-1 bg-gray-50 border border-gray-200 rounded-lg">
                        <div class="flex items-center text-xs text-gray-600">
                            <i class="fas fa-robot mr-1"></i>
                            <span>AI Generated Targets</span>
                        </div>
                    </div>
                    `}

                    <!-- Actions -->
                    <div class="mt-4 pt-3 border-t border-gray-100">
                        <div class="flex justify-between items-center">
                            <div class="text-xs text-gray-500">
                                Last updated: ${new Date().toLocaleDateString()}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="openMacroAdjustmentModal('${clientEmail}', '${clientName}', ${JSON.stringify(targets).replace(/"/g, '&quot;')}, '${macros.macroSource}')" 
                                        class="text-green-600 hover:text-green-800 text-sm font-medium px-3 py-2 rounded-lg hover:bg-green-50 transition-colors touch-target">
                                    <i class="fas fa-edit mr-1"></i>
                                    <span class="hidden sm:inline">Adjust Macros</span>
                                    <span class="sm:hidden">Edit</span>
                                </button>
                                <button onclick="viewClientDetails('${clientName}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium px-3 py-2 rounded-lg hover:bg-blue-50 transition-colors touch-target">
                                    <i class="fas fa-external-link-alt mr-1"></i>
                                    <span class="hidden sm:inline">View Details</span>
                                    <span class="sm:hidden">Details</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return div;
        }
        
        // Toggle function for client details
        function toggleClientDetails(cardId) {
            const detailsElement = document.getElementById(`details-${cardId}`);
            const iconElement = document.getElementById(`toggle-icon-${cardId}`);
            
            if (detailsElement.classList.contains('hidden')) {
                detailsElement.classList.remove('hidden');
                iconElement.classList.add('rotate-180');
            } else {
                detailsElement.classList.add('hidden');
                iconElement.classList.remove('rotate-180');
            }
        }

        function updateStats(clients, clientsWithMacros) {
            document.getElementById('stat-client-count').textContent = clients.length;
            
            if (clientsWithMacros.length === 0) {
                document.getElementById('stat-on-track').textContent = '0';
                document.getElementById('stat-meals-today').textContent = '0';
                document.getElementById('stat-avg-adherence').textContent = '0%';
                return;
            }
            
            let onTrackCount = 0;
            let totalMeals = 0;
            let totalAdherence = 0;
            let validClients = 0;
            
            clientsWithMacros.forEach(client => {
                if (client.macros) {
                    const { consumed, targets, mealsCount } = client.macros;
                    
                    // Calculate adherence
                    const caloriesPercent = Math.min((consumed.calories / targets.calories) * 100, 100);
                    const proteinPercent = Math.min((consumed.protein / targets.protein) * 100, 100);
                    const carbsPercent = Math.min((consumed.carbs / targets.carbs) * 100, 100);
                    const fatPercent = Math.min((consumed.fat / targets.fat) * 100, 100);
                    
                    const adherence = (caloriesPercent + proteinPercent + carbsPercent + fatPercent) / 4;
                    
                    if (adherence >= 80) onTrackCount++;
                    totalMeals += mealsCount;
                    totalAdherence += adherence;
                    validClients++;
                }
            });
            
            document.getElementById('stat-on-track').textContent = onTrackCount;
            document.getElementById('stat-meals-today').textContent = totalMeals;
            document.getElementById('stat-avg-adherence').textContent = validClients > 0 ? 
                Math.round(totalAdherence / validClients) + '%' : '0%';
        }



        // View switching functions


        // Admin Users Management Functions

        // Macro Adjustment Modal Functions
        let currentClientData = {};

        function openMacroAdjustmentModal(clientEmail, clientName, currentTargets, macroSource) {
            // Store current client data
            currentClientData = {
                email: clientEmail,
                name: clientName,
                currentTargets: currentTargets,
                macroSource: macroSource
            };

            // Populate modal with client info
            document.getElementById('modal-client-name').textContent = clientName;
            document.getElementById('modal-client-email').textContent = clientEmail;
            document.getElementById('modal-client-email-input').value = clientEmail;

            // Populate current values
            document.getElementById('adjusted-calories').value = Math.round(currentTargets.calories);
            document.getElementById('adjusted-protein').value = Math.round(currentTargets.protein);
            document.getElementById('adjusted-carbs').value = Math.round(currentTargets.carbs);
            document.getElementById('adjusted-fat').value = Math.round(currentTargets.fat);

            // Update source indicator
            updateSourceIndicator(macroSource);

            // Show modal
            document.getElementById('macro-adjustment-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeMacroAdjustmentModal() {
            document.getElementById('macro-adjustment-modal').classList.add('hidden');
            document.body.style.overflow = ''; // Restore scrolling
            
            // Clear form
            document.getElementById('macro-adjustment-form').reset();
            document.getElementById('adjustment-reason').value = '';
            currentClientData = {};
        }

        function updateSourceIndicator(macroSource) {
            const indicator = document.getElementById('current-source-indicator');
            
            if (macroSource === 'coach_adjusted') {
                indicator.innerHTML = `
                    <div class="flex items-center text-blue-700 bg-blue-50 border-blue-200">
                        <i class="fas fa-user-cog mr-2"></i>
                        <span class="font-medium">Currently Using Coach-Adjusted Values</span>
                    </div>
                `;
                indicator.className = 'px-3 py-2 rounded-lg border bg-blue-50 border-blue-200';
            } else {
                indicator.innerHTML = `
                    <div class="flex items-center text-gray-700">
                        <i class="fas fa-robot mr-2"></i>
                        <span class="font-medium">Currently Using AI-Generated Values</span>
                    </div>
                `;
                indicator.className = 'px-3 py-2 rounded-lg border bg-gray-50 border-gray-200';
            }
        }

        async function saveMacroAdjustments(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const adjustments = {
                clientEmail: formData.get('clientEmail'),
                calories: parseInt(formData.get('calories')),
                protein: parseInt(formData.get('protein')),
                carbs: parseInt(formData.get('carbs')),
                fat: parseInt(formData.get('fat')),
                reason: formData.get('reason') || null
            };

            // Validate inputs
            if (!adjustments.calories || !adjustments.protein || !adjustments.carbs || !adjustments.fat) {
                showError('Please fill in all macro values');
                return;
            }

            if (adjustments.calories < 800 || adjustments.calories > 5000) {
                showError('Calories must be between 800 and 5000');
                return;
            }

            try {
                // Get current coach info
                let coachInfo = window.coachAuthWrapper.getCurrentCoach();
                console.log('🔍 Coach info for macro adjustment:', coachInfo);
                
                if (!coachInfo || !coachInfo.isAuthenticated) {
                    showError('Coach authentication required. Please refresh and log in again.');
                    return;
                }
                
                // Ensure coach ID is available
                const coachUserId = coachInfo.id || coachInfo.user?.id || coachInfo.user_id || null;
                if (!coachUserId) {
                    console.error('❌ Coach user ID not found in auth data');
                    showError('Coach ID not found. Please refresh and log in again.');
                    return;
                }
                
                // Get original AI values for comparison (from daily_targets)
                const { data: aiTargets } = await window.supabaseClient
                    .from('daily_targets')
                    .select('daily_calories, daily_protein, daily_carbs, daily_fat')
                    .eq('user_email', adjustments.clientEmail)
                    .order('created_at', { ascending: false })
                    .limit(1);

                const originalAI = aiTargets && aiTargets.length > 0 ? {
                    calories: aiTargets[0].daily_calories || 2000,
                    protein: aiTargets[0].daily_protein || 150,
                    carbs: aiTargets[0].daily_carbs || 200,
                    fat: aiTargets[0].daily_fat || 65
                } : { calories: 2000, protein: 150, carbs: 200, fat: 65 };

                // Save coach adjustment
                console.log('💾 Saving macro adjustments:', {
                    client_email: adjustments.clientEmail,
                    coach_user_id: coachUserId,
                    coach_email: coachInfo.email,
                    adjustments: adjustments
                });
                
                const { data, error } = await window.supabaseClient
                    .from('coach_macro_adjustments')
                    .upsert({
                        client_email: adjustments.clientEmail,
                        coach_user_id: coachUserId,
                        coach_email: coachInfo.email,
                        adjusted_calories: adjustments.calories,
                        adjusted_protein: adjustments.protein,
                        adjusted_carbs: adjustments.carbs,
                        adjusted_fat: adjustments.fat,
                        adjustment_reason: adjustments.reason,
                        original_ai_calories: originalAI.calories,
                        original_ai_protein: originalAI.protein,
                        original_ai_carbs: originalAI.carbs,
                        original_ai_fat: originalAI.fat
                    }, {
                        onConflict: 'client_email,coach_email'
                    });
                
                console.log('💾 Save result:', { data, error });

                if (error) {
                    console.error('Error saving macro adjustments:', error);
                    showError('Failed to save macro adjustments: ' + error.message);
                    return;
                }

                showSuccess('Macro adjustments saved successfully!');
                closeMacroAdjustmentModal();
                
                // Refresh the dashboard to show updated values
                if (!isLoadingDashboard) {
                    await loadDashboardContent();
                }
                
            } catch (error) {
                console.error('Error saving macro adjustments:', error);
                showError('An error occurred while saving adjustments');
            }
        }

        async function revertToAIMacros() {
            if (!currentClientData.email) {
                showError('No client selected');
                return;
            }

            // Show professional confirmation dialog
            const confirmRevert = await showConfirmDialog(
                'Revert to AI Macros?', 
                'This will remove all custom macro adjustments and restore the original AI-generated values. This action cannot be undone.',
                'Revert to AI',
                'Cancel'
            );
            
            if (!confirmRevert) {
                return;
            }

            try {
                let coachInfo = window.coachAuthWrapper.getCurrentCoach();
                console.log('🔍 Coach info for revert:', coachInfo);
                
                if (!coachInfo || !coachInfo.isAuthenticated) {
                    showError('Coach authentication required. Please refresh and log in again.');
                    return;
                }
                
                // Delete the coach adjustment record
                const { error } = await window.supabaseClient
                    .from('coach_macro_adjustments')
                    .delete()
                    .eq('client_email', currentClientData.email)
                    .eq('coach_email', coachInfo.email);

                if (error) {
                    console.error('Error reverting macro adjustments:', error);
                    showError('Failed to revert to AI macros: ' + error.message);
                    return;
                }

                showSuccess('Successfully reverted to AI-generated macros');
                closeMacroAdjustmentModal();
                
                // Refresh the dashboard
                if (!isLoadingDashboard) {
                    await loadDashboardContent();
                }
                
            } catch (error) {
                console.error('Error reverting macro adjustments:', error);
                showError('An error occurred while reverting to AI macros');
            }
        }

        // Professional Notification System
        let notificationId = 0;

        function createNotification(type, title, message, duration = 5000) {
            const container = document.getElementById('notification-container');
            if (!container) return;

            notificationId++;
            const id = `notification-${notificationId}`;

            // Icon mapping for different types
            const icons = {
                error: 'fas fa-exclamation-circle',
                success: 'fas fa-check-circle',
                info: 'fas fa-info-circle',
                warning: 'fas fa-exclamation-triangle'
            };

            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.id = id;
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="${icons[type] || icons.info}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="removeNotification('${id}')">
                    <i class="fas fa-times"></i>
                </button>
            `;

            // Add to container
            container.appendChild(notification);

            // Show notification with animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);

            // Auto-remove after duration (if duration > 0)
            if (duration > 0) {
                setTimeout(() => {
                    removeNotification(id);
                }, duration);
            }

            return id;
        }

        function removeNotification(id) {
            const notification = document.getElementById(id);
            if (!notification) return;

            notification.classList.add('hide');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 400);
        }

        function showAlert(message, title = 'Notification', type = 'info') {
            return createNotification(type, title, message);
        }

        function showError(message, title = 'Error') {
            return createNotification('error', title, message, 6000);
        }

        function showSuccess(message, title = 'Success') {
            return createNotification('success', title, message, 4000);
        }

        function showInfo(message, title = 'Information') {
            return createNotification('info', title, message, 5000);
        }

        function showWarning(message, title = 'Warning') {
            return createNotification('warning', title, message, 6000);
        }

        // Professional confirmation dialog
        function showConfirmDialog(title, message, confirmText = 'Confirm', cancelText = 'Cancel') {
            return new Promise((resolve) => {
                // Create modal backdrop
                const backdrop = document.createElement('div');
                backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                
                // Create modal content
                backdrop.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-md w-full m-4 transform transition-all">
                        <div class="p-6">
                            <div class="flex items-center mb-4">
                                <div class="flex-shrink-0">
                                    <div class="flex items-center justify-center h-10 w-10 rounded-full bg-yellow-100">
                                        <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <h3 class="text-lg font-medium text-gray-900">${title}</h3>
                                </div>
                            </div>
                            <div class="mb-6">
                                <p class="text-sm text-gray-600">${message}</p>
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button id="confirm-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors">
                                    ${cancelText}
                                </button>
                                <button id="confirm-action" class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">
                                    ${confirmText}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add event listeners
                const cancelBtn = backdrop.querySelector('#confirm-cancel');
                const confirmBtn = backdrop.querySelector('#confirm-action');
                
                const cleanup = () => {
                    document.body.removeChild(backdrop);
                    document.body.style.overflow = '';
                };
                
                cancelBtn.addEventListener('click', () => {
                    cleanup();
                    resolve(false);
                });
                
                confirmBtn.addEventListener('click', () => {
                    cleanup();
                    resolve(true);
                });
                
                // Close on backdrop click
                backdrop.addEventListener('click', (e) => {
                    if (e.target === backdrop) {
                        cleanup();
                        resolve(false);
                    }
                });
                
                // Close on Escape key
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        document.removeEventListener('keydown', handleEscape);
                        cleanup();
                        resolve(false);
                    }
                };
                document.addEventListener('keydown', handleEscape);
                
                // Show modal
                document.body.appendChild(backdrop);
                document.body.style.overflow = 'hidden';
                
                // Focus confirm button
                setTimeout(() => confirmBtn.focus(), 100);
            });
        }
        
        // Loading state management is handled at global scope
        
        // Utility functions
        async function refreshClients() {
            // Prevent multiple simultaneous refreshes
            if (isLoadingDashboard) {
                console.log('🔄 Refresh already in progress, ignoring duplicate request');
                showInfo('Refresh in Progress', 'Please wait for the current refresh to complete.');
                return;
            }
            
            console.log('🔄 Manual refresh requested');
            
            // Update button state to show loading
            const refreshButton = document.getElementById('refresh-button');
            const refreshIcon = document.getElementById('refresh-icon');
            const refreshTextFull = document.getElementById('refresh-text-full');
            const refreshTextShort = document.getElementById('refresh-text-short');
            
            if (refreshButton) {
                refreshButton.disabled = true;
                refreshIcon.className = 'fas fa-spinner fa-spin mr-2';
                refreshTextFull.textContent = 'Refreshing...';
                refreshTextShort.textContent = 'Loading';
            }
            
            try {
                await loadDashboardContent();
                showSuccess('Data Refreshed', 'Client information has been updated.');
            } catch (error) {
                console.error('Refresh failed:', error);
                showError('Refresh Failed', 'Unable to refresh data. Please try again.');
            } finally {
                // Reset button state
                if (refreshButton) {
                    refreshButton.disabled = false;
                    refreshIcon.className = 'fas fa-sync-alt mr-2';
                    refreshTextFull.textContent = 'Refresh Data';
                    refreshTextShort.textContent = 'Refresh';
                }
            }
        }
        
        // Auto-refresh functionality
        let autoRefreshInterval = null;
        
        function startAutoRefresh() {
            // Auto-refresh every 2 minutes to catch client updates
            autoRefreshInterval = setInterval(async () => {
                console.log('🔄 Auto-refreshing client data...');
                if (!isLoadingDashboard) {
                    await loadDashboardContent();
                } else {
                    console.log('⚠️ Skipping auto-refresh - dashboard loading in progress');
                }
            }, 120000); // 2 minutes
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // Start auto-refresh when dashboard loads
        document.addEventListener('DOMContentLoaded', () => {
            // Start auto-refresh after initial load (with safety checks)
            setTimeout(startAutoRefresh, 10000); // Start after 10 seconds to allow full initialization
        });

        function filterByDate() {
            selectedDate = document.getElementById('date-filter').value;
            loadDashboardContent();
        }

        function viewClientDetails(clientName) {
            // Placeholder for client detail view
            showInfo('Coming Soon\n\nClient detailed analytics and progress tracking will be available soon. Stay tuned for this exciting feature!');
        }










        


        // Modal ESC key handler
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('macro-adjustment-modal');
                if (modal && !modal.classList.contains('hidden')) {
                    closeMacroAdjustmentModal();
                }
            }
        });

        // ===================================
        // PROGRESS REPORTS FUNCTIONALITY
        // ===================================

        // Essential Progress Reports Functions - removed duplicate showSection function

        // Progress Reports Main Functions
        function loadProgressReportsContent() {
            console.log('📊 Loading Progress Reports content...');
            
            // Load initial report statistics
            loadReportStats();
            
            // Load default tab (My Reports)
            showReportTab('my-reports');
        }
        
        // Report Tab Switching Function
        function showReportTab(tabName) {
            console.log('📋 Switching to report tab:', tabName);
            
            // Update tab button states
            document.querySelectorAll('.report-tab-button').forEach(function(tab) {
                tab.classList.remove('active', 'text-blue-600', 'border-blue-500');
                tab.classList.add('text-gray-500', 'border-transparent');
            });
            
            // Activate selected tab
            const activeTab = document.getElementById(tabName + '-tab');
            if (activeTab) {
                activeTab.classList.add('active', 'text-blue-600', 'border-blue-500');
                activeTab.classList.remove('text-gray-500', 'border-transparent');
            }
            
            // Hide all tab content
            document.querySelectorAll('.report-tab-content').forEach(function(content) {
                content.classList.add('hidden');
            });
            
            // Show selected tab content
            const targetContent = document.getElementById(tabName + '-content');
            if (targetContent) {
                targetContent.classList.remove('hidden');
            }
            
            // Load tab-specific content
            switch(tabName) {
                case 'my-reports':
                    loadMyReports();
                    break;
                case 'templates':
                    loadReportTemplates();
                    break;
                case 'shared':
                    loadSharedReports();
                    break;
                default:
                    console.log('Unknown report tab:', tabName);
            }
        }

        // Progress Reports Core Functions
        async function loadReportStats() {
            console.log('📊 Loading report statistics...');
            
            try {
                let coachInfo = window.coachAuthWrapper.getCurrentCoach();
                if (!coachInfo.isAuthenticated) return;

                // Get total reports count
                const { data: allReports, error: reportsError } = await window.supabaseClient
                    .from('progress_reports')
                    .select('id, created_at, report_status')
                    .eq('coach_email', coachInfo.email);

                if (!reportsError && allReports) {
                    const totalReports = allReports.length;
                    const thisMonth = new Date();
                    const firstDayOfMonth = new Date(thisMonth.getFullYear(), thisMonth.getMonth(), 1);
                    const monthlyReports = allReports.filter(r => new Date(r.created_at) >= firstDayOfMonth).length;

                    // Update stats display
                    document.getElementById('stat-total-reports').textContent = totalReports;
                    document.getElementById('stat-monthly-reports').textContent = monthlyReports;
                }

                // Get shared reports count
                const { data: sharedReports, error: sharedError } = await window.supabaseClient
                    .from('report_shares')
                    .select('id')
                    .eq('shared_by_coach_email', coachInfo.email);

                if (!sharedError && sharedReports) {
                    document.getElementById('stat-shared-reports').textContent = sharedReports.length;
                }

            } catch (error) {
                console.error('❌ Error loading report stats:', error);
                // Set default values on error
                document.getElementById('stat-total-reports').textContent = '0';
                document.getElementById('stat-monthly-reports').textContent = '0';
                document.getElementById('stat-shared-reports').textContent = '0';
            }
        }

        async function loadMyReports() {
            console.log('📁 Loading my reports...');
            
            try {
                let coachInfo = window.coachAuthWrapper.getCurrentCoach();
                if (!coachInfo.isAuthenticated) {
                    console.log('⚠️ Not authenticated, cannot load reports');
                    return;
                }

                console.log('🔍 Fetching reports for coach:', coachInfo.email);

                const { data: reports, error } = await window.supabaseClient
                    .from('progress_reports')
                    .select('*')
                    .eq('coach_email', coachInfo.email)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('❌ Error loading reports:', error);
                    showError('Failed to load reports', 'Unable to fetch your reports. Please check your permissions.');
                    return;
                }

                console.log('✅ Loaded reports:', reports);
                currentReports = reports || [];
                renderReportsList(reports || []);

            } catch (error) {
                console.error('❌ Error loading reports:', error);
                showError('Failed to load reports', 'An unexpected error occurred while loading reports.');
            }
        }



        async function loadSharedReports() {
            console.log('👥 Loading shared reports...');
            
            try {
                let coachInfo = window.coachAuthWrapper.getCurrentCoach();
                if (!coachInfo.isAuthenticated) {
                    console.log('⚠️ Not authenticated, cannot load shared reports');
                    return;
                }

                console.log('🔍 Fetching shared reports for coach:', coachInfo.email);

                const { data: sharedReports, error } = await window.supabaseClient
                    .from('report_shares')
                    .select(`
                        *,
                        progress_reports (
                            id,
                            report_title,
                            created_at,
                            client_name
                        )
                    `)
                    .eq('shared_by_coach_email', coachInfo.email)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('❌ Error loading shared reports:', error);
                    showError('Failed to load shared reports', 'Unable to fetch shared reports.');
                    return;
                }

                console.log('✅ Loaded shared reports:', sharedReports);
                currentSharedReports = sharedReports || [];
                renderSharedReportsList(sharedReports || []);

            } catch (error) {
                console.error('❌ Error loading shared reports:', error);
                showError('Failed to load shared reports', 'An unexpected error occurred while loading shared reports.');
            }
        }

        // Progress Reports Render Functions
        function renderReportsList(reports) {
            const reportsGrid = document.getElementById('reports-list');
            if (!reportsGrid) {
                console.warn('⚠️ Reports grid container not found');
                return;
            }

            if (!reports || reports.length === 0) {
                reportsGrid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="inline-block p-3 bg-gray-100 rounded-full mb-4">
                            <i class="fas fa-chart-bar text-4xl text-gray-400"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-600 mb-2">No Reports Yet</h3>
                        <p class="text-gray-500 mb-4">Create your first progress report to get started</p>
                        <button onclick="showCreateReportModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Create Report
                        </button>
                    </div>
                `;
                return;
            }

            const reportsHtml = reports.map(report => `
                <div class="bg-white border border-gray-200 rounded-lg p-3 sm:p-4 md:p-6 hover:shadow-md transition-shadow w-full overflow-hidden">
                    <!-- Header Section -->
                    <div class="flex flex-col gap-2 sm:gap-0 sm:flex-row sm:items-start sm:justify-between mb-3 sm:mb-4">
                        <div class="flex-1 min-w-0 pr-2">
                            <h4 class="font-semibold text-gray-900 text-sm sm:text-base md:text-lg break-words">${escapeHtml(report.report_title || 'Untitled Report')}</h4>
                            <p class="text-xs sm:text-sm text-gray-600 mt-1 break-words"><i class="fas fa-user mr-1"></i>${escapeHtml(report.client_name || report.client_email?.split('@')[0] || 'Unknown Client')}</p>
                        </div>
                        <div class="flex-shrink-0 self-start">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getReportStatusClass(report.report_status)}">
                                ${(report.report_status || 'draft').toUpperCase()}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Details Section -->
                    <div class="flex flex-col text-xs sm:text-sm text-gray-500 mb-4 space-y-1">
                        <span class="break-words"><i class="fas fa-calendar mr-1 flex-shrink-0"></i>Created: ${formatDate(report.created_at)}</span>
                        <span class="break-words"><i class="fas fa-chart-line mr-1 flex-shrink-0"></i>Type: ${(report.report_type || 'weekly').charAt(0).toUpperCase() + (report.report_type || 'weekly').slice(1)}</span>
                        <span class="break-words"><i class="fas fa-clock mr-1 flex-shrink-0"></i>Period: ${formatDate(report.date_from)} - ${formatDate(report.date_to)}</span>
                    </div>
                    
                    <!-- Actions Section -->
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                        <button onclick="viewReportDetails('${report.id}')" class="bg-blue-50 text-blue-600 px-2 sm:px-3 py-2 rounded text-xs sm:text-sm font-medium hover:bg-blue-100 transition-colors flex items-center justify-center">
                            <i class="fas fa-eye mr-1"></i><span class="hidden sm:inline">View Details</span><span class="sm:hidden">View</span>
                        </button>
                        ${report.report_status === 'completed' ? `
                        <button onclick="downloadReport('${report.id}')" class="bg-green-50 text-green-600 px-2 sm:px-3 py-2 rounded text-xs sm:text-sm font-medium hover:bg-green-100 transition-colors flex items-center justify-center">
                            <i class="fas fa-download mr-1"></i><span class="hidden sm:inline">Download</span><span class="sm:hidden">PDF</span>
                        </button>
                        ` : '<div></div>'}
                        <button onclick="shareReportModal('${report.id}')" class="bg-purple-50 text-purple-600 px-2 sm:px-3 py-2 rounded text-xs sm:text-sm font-medium hover:bg-purple-100 transition-colors flex items-center justify-center">
                            <i class="fas fa-share mr-1"></i><span class="hidden sm:inline">Share</span><span class="sm:hidden">Share</span>
                        </button>
                        <button onclick="deleteReport('${report.id}')" class="bg-red-50 text-red-600 px-2 sm:px-3 py-2 rounded text-xs sm:text-sm font-medium hover:bg-red-100 transition-colors flex items-center justify-center">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            reportsGrid.innerHTML = reportsHtml;
        }

        function renderTemplatesList(templates) {
            const templatesGrid = document.getElementById('templates-grid');
            if (!templatesGrid) {
                console.warn('⚠️ Templates grid container not found');
                return;
            }

            if (!templates || templates.length === 0) {
                templatesGrid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-file-alt text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-600 mb-2">No Templates Yet</h3>
                        <p class="text-gray-500 mb-4">Create your first report template to streamline your workflow</p>
                        <button onclick="showCreateTemplateModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Create Template
                        </button>
                    </div>
                `;
                return;
            }

            const templatesHtml = templates.map(template => `
                <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h4 class="font-semibold text-gray-900">${escapeHtml(template.name || 'Untitled Template')}</h4>
                            <p class="text-sm text-gray-600">${escapeHtml(template.description || 'No description')}</p>
                        </div>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                            ${template.type || 'weekly'}
                        </span>
                    </div>
                    <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                        <span><i class="fas fa-calendar mr-1"></i>${formatDate(template.created_at)}</span>
                        <span><i class="fas fa-list mr-1"></i>${(template.metrics || []).length} metrics</span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editTemplate('${template.id}')" class="flex-1 bg-blue-50 text-blue-600 px-3 py-2 rounded text-sm hover:bg-blue-100 transition-colors">
                            <i class="fas fa-edit mr-1"></i>Edit
                        </button>
                        <button onclick="duplicateTemplate('${template.id}')" class="flex-1 bg-green-50 text-green-600 px-3 py-2 rounded text-sm hover:bg-green-100 transition-colors">
                            <i class="fas fa-copy mr-1"></i>Copy
                        </button>
                        <button onclick="deleteTemplate('${template.id}')" class="bg-red-50 text-red-600 px-3 py-2 rounded text-sm hover:bg-red-100 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            templatesGrid.innerHTML = templatesHtml;
        }

        function renderSharedReportsList(sharedReports) {
            const sharedReportsList = document.getElementById('shared-reports-list');
            if (!sharedReportsList) {
                console.warn('⚠️ Shared reports list container not found');
                return;
            }

            if (!sharedReports || sharedReports.length === 0) {
                sharedReportsList.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="inline-block p-3 bg-gray-100 rounded-full mb-4">
                            <i class="fas fa-share-alt text-4xl text-gray-400"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-600 mb-2">No Shared Reports</h3>
                        <p class="text-gray-500 mb-4">Share reports with clients to start building your list</p>
                    </div>
                `;
                return;
            }

            const sharedReportsHtml = sharedReports.map(share => {
                const report = share.progress_reports || {};
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-3 sm:p-4 md:p-6 hover:shadow-md transition-shadow w-full overflow-hidden mb-4">
                        <!-- Header Section -->
                        <div class="flex flex-col gap-2 sm:gap-0 sm:flex-row sm:items-start sm:justify-between mb-3 sm:mb-4">
                            <div class="flex-1 min-w-0 pr-2">
                                <h4 class="font-semibold text-gray-900 text-sm sm:text-base md:text-lg break-words">${escapeHtml(report.report_title || 'Untitled Report')}</h4>
                                <p class="text-xs sm:text-sm text-gray-600 mt-1 break-words"><i class="fas fa-user mr-1"></i>${escapeHtml(report.client_name || report.client_email?.split('@')[0] || 'Unknown Client')}</p>
                            </div>
                            <div class="flex-shrink-0 self-start">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${share.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                    ${share.is_active ? 'ACTIVE' : 'EXPIRED'}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Details Section -->
                        <div class="flex flex-col text-xs sm:text-sm text-gray-500 mb-4 space-y-1">
                            <span class="break-words"><i class="fas fa-share mr-1 flex-shrink-0"></i>Shared to: ${escapeHtml(share.shared_with_email)}</span>
                            <span class="break-words"><i class="fas fa-calendar mr-1 flex-shrink-0"></i>Shared on: ${formatDate(share.created_at)}</span>
                            <span class="break-words"><i class="fas fa-eye mr-1 flex-shrink-0"></i>Views: ${share.access_count || 0}</span>
                        </div>
                        
                        <!-- Actions Section -->
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="copyShareLink('${share.share_token || share.id}')" class="bg-blue-50 text-blue-600 px-2 sm:px-3 py-2 rounded text-xs sm:text-sm font-medium hover:bg-blue-100 transition-colors flex items-center justify-center">
                                <i class="fas fa-link mr-1"></i><span class="hidden sm:inline">Copy Share Link</span><span class="sm:hidden">Copy Link</span>
                            </button>
                            <button onclick="revokeReportShare('${share.id}')" class="bg-red-50 text-red-600 px-2 sm:px-3 py-2 rounded text-xs sm:text-sm font-medium hover:bg-red-100 transition-colors flex items-center justify-center">
                                <i class="fas fa-times mr-1"></i><span class="hidden sm:inline">Revoke Access</span><span class="sm:hidden">Revoke</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            sharedReportsList.innerHTML = sharedReportsHtml;
        }

        // Helper Functions for Reports
        function getReportStatusClass(status) {
            switch (status) {
                case 'completed':
                    return 'bg-green-100 text-green-800';
                case 'in_progress':
                    return 'bg-yellow-100 text-yellow-800';
                case 'draft':
                    return 'bg-gray-100 text-gray-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown date';
            try {
                return new Date(dateString).toLocaleDateString();
            } catch (error) {
                return 'Invalid date';
            }
        }

        function revokeReportShare(shareId) {
            console.log('🚫 Revoking report share:', shareId);
            showInfo('Feature Coming Soon', 'Report share revocation will be available in the next update.');
        }

        function shareReportModal(reportId) {
            console.log('📤 Opening share modal for report:', reportId);
            // The shareReport function and modal already exist
            selectedReportId = reportId;
            const modal = document.getElementById('share-report-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        // Progress Reports Modal Functions
        async function showCreateReportModal() {
            console.log('📊 Opening create report modal...');
            
            // Populate client dropdown first
            const clientSelect = document.getElementById('report-client-select');
            if (clientSelect) {
                if (clientsData && clientsData.length > 0) {
                    clientSelect.innerHTML = '<option value="">Choose a client...</option>' + 
                        clientsData.map(function(client) {
                            const email = client.user_email || client.email;
                            const name = client.user_name || client.display_name || email;
                            return '<option value="' + email + '">' + escapeHtml(name) + '</option>';
                        }).join('');
                } else {
                    // No clients available
                    clientSelect.innerHTML = '<option value="">No clients available</option>';
                    console.log('⚠️ No client data available for report creation');
                }
            }
            
            // Load templates for dropdown (async)
            await loadTemplatesForDropdown();
            
            // Set up event listeners
            setupReportTypeListeners();
            
            // Show modal
            const modal = document.getElementById('create-report-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }
        
        function closeCreateReportModal() {
            console.log('❌ Closing create report modal...');
            const modal = document.getElementById('create-report-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            
            // Reset form
            const form = document.getElementById('create-report-form');
            if (form) {
                form.reset();
            }
            
            // Hide custom date range
            const customRange = document.getElementById('custom-date-range');
            if (customRange) {
                customRange.classList.add('hidden');
            }
        }
        
        // Template Modal Functions
        function showCreateTemplateModal() {
            console.log('📝 Opening create template modal...');
            
            const modal = document.getElementById('create-template-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }
        
        function closeCreateTemplateModal() {
            console.log('❌ Closing create template modal...');
            const modal = document.getElementById('create-template-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            
            // Reset form
            const form = document.getElementById('create-template-form');
            if (form) {
                form.reset();
                form.removeAttribute('data-template-id');
                
                // Reset radio buttons to default (weekly)
                const weeklyRadio = document.getElementById('template-weekly');
                if (weeklyRadio) {
                    weeklyRadio.checked = true;
                }
                
                // Reset modal title and button text to create mode
                const modalTitle = document.querySelector('#create-template-modal h3');
                const submitButton = document.querySelector('#create-template-form button[type="submit"]');
                
                if (modalTitle) {
                    modalTitle.innerHTML = '<i class="fas fa-file-alt text-blue-600 mr-2"></i>Create Report Template';
                }
                
                if (submitButton) {
                    submitButton.innerHTML = '<i class="fas fa-save mr-2"></i>Create Template';
                }
            }
        }
        
        // Show Coming Soon Notification for Disabled Metrics
        function showComingSoonNotification(metricName) {
            console.log('🚧 Coming soon notification for:', metricName);
            showInfo(
                'Coming Soon!', 
                metricName + ' tracking will be available in a future update. We\'re working hard to bring you comprehensive progress analytics!'
            );
        }
        
        async function createReportTemplate(event) {
            if (event) event.preventDefault();
            
            try {
                const form = document.getElementById('create-template-form');
                const templateId = form.getAttribute('data-template-id');
                const isEditing = templateId && templateId !== '';
                
                console.log(isEditing ? '✏️ Updating report template...' : '📝 Creating report template...');
                
                // Get coach info
                let coachInfo = window.coachAuthWrapper.getCurrentCoach();
                if (!coachInfo.isAuthenticated) {
                    showError('Authentication Error', 'You must be logged in to create templates.');
                    return;
                }
                
                // Get form data
                const templateName = document.getElementById('template-name').value.trim();
                const templateDescription = document.getElementById('template-description').value.trim();
                const templateType = document.querySelector('input[name="template-type"]:checked').value;
                
                // Get selected metrics (only enabled ones)
                const selectedMetrics = [];
                const metricCheckboxes = document.querySelectorAll('input[name="template-metrics"]:checked:not([disabled])');
                metricCheckboxes.forEach(function(checkbox) {
                    selectedMetrics.push(checkbox.value);
                });
                
                if (!templateName) {
                    showError('Validation Error', 'Please enter a template name.');
                    return;
                }
                
                if (selectedMetrics.length === 0) {
                    showError('Validation Error', 'Please select at least one available metric to include in the template.');
                    return;
                }
                
                // Create template configuration object
                const templateConfig = {
                    type: templateType,
                    metrics: selectedMetrics,
                    sections: selectedMetrics.map(metric => ({
                        metric: metric,
                        enabled: true,
                        chartType: 'line' // default chart type
                    }))
                };
                
                if (isEditing) {
                    // Update existing template in database
                    const { data: updatedTemplate, error } = await window.supabaseClient
                        .from('report_templates')
                        .update({
                            template_name: templateName,
                            template_description: templateDescription,
                            template_config: templateConfig,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', templateId)
                        .eq('coach_user_id', coachInfo.id)
                        .select()
                        .single();

                    if (error) throw error;
                    
                    showSuccess('Template Updated', 'Your report template "' + templateName + '" has been updated successfully.');
                    
                } else {
                    // Create new template in database
                    const { data: newTemplate, error } = await window.supabaseClient
                        .from('report_templates')
                        .insert([{
                            coach_user_id: coachInfo.id,
                            coach_email: coachInfo.email,
                            template_name: templateName,
                            template_description: templateDescription,
                            template_config: templateConfig,
                            is_default: false,
                            is_system_template: false,
                            is_active: true,
                            usage_count: 0
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    
                    showSuccess('Template Created', 'Your report template "' + templateName + '" has been created successfully.');
                    console.log('✅ Template created successfully:', newTemplate);
                }
                
                closeCreateTemplateModal();
                
                // Refresh templates display
                await loadReportTemplates();
                
            } catch (error) {
                console.error('❌ Error creating/updating template:', error);
                showError('Template Error', 'Failed to save template: ' + error.message);
            }
        }
        
        async function refreshTemplatesDisplay() {
            console.log('🔄 Refreshing templates display...');
            try {
                await loadReportTemplates();
                console.log('✅ Templates display refreshed successfully');
            } catch (error) {
                console.error('❌ Error refreshing templates display:', error);
                showError('Refresh Error', 'Failed to refresh templates display');
            }
        }
        
        function editTemplate(templateId) {
            console.log('✏️ Editing template:', templateId);
            
            if (!currentTemplates) {
                console.warn('⚠️ No templates data available');
                return;
            }
            
            const template = currentTemplates.find(t => t.id === templateId);
            if (!template) {
                showError('Template Not Found', 'The selected template could not be found.');
                return;
            }
            
            // Pre-populate the create template modal with existing data
            document.getElementById('template-name').value = template.name || '';
            document.getElementById('template-description').value = template.description || '';
            
            // Set template type
            if (template.type === 'monthly') {
                document.getElementById('template-monthly').checked = true;
            } else {
                document.getElementById('template-weekly').checked = true;
            }
            
            // Set metrics checkboxes
            const metricCheckboxes = document.querySelectorAll('input[name="template-metrics"]');
            metricCheckboxes.forEach(function(checkbox) {
                checkbox.checked = template.metrics && template.metrics.includes(checkbox.value);
            });
            
            // Change modal title and button text
            document.querySelector('#create-template-modal h3').innerHTML = 
                '<i class="fas fa-edit text-blue-600 mr-2"></i>Edit Report Template';
            document.querySelector('#create-template-form button[type="submit"]').innerHTML = 
                '<i class="fas fa-save mr-2"></i>Update Template';
            
            // Store the template ID for updating
            document.getElementById('create-template-form').setAttribute('data-template-id', templateId);
            
            // Show modal
            showCreateTemplateModal();
        }
        
        function deleteTemplate(templateId) {
            console.log('🗑️ Deleting template:', templateId);
            
            if (!currentTemplates) {
                console.warn('⚠️ No templates data available');
                return;
            }
            
            const template = currentTemplates.find(t => t.id === templateId);
            if (!template) {
                showError('Template Not Found', 'The selected template could not be found.');
                return;
            }
            
            // Show confirmation dialog
            if (confirm('Are you sure you want to delete the template "' + template.name + '"? This action cannot be undone.')) {
                // Remove from current templates array
                currentTemplates = currentTemplates.filter(t => t.id !== templateId);
                
                showSuccess('Template Deleted', 'The template "' + template.name + '" has been deleted successfully.');
                refreshTemplatesDisplay();
            }
        }
        
        function duplicateTemplate(templateId) {
            console.log('📋 Duplicating template:', templateId);
            
            if (!currentTemplates) {
                console.warn('⚠️ No templates data available');
                return;
            }
            
            const template = currentTemplates.find(t => t.id === templateId);
            if (!template) {
                showError('Template Not Found', 'The selected template could not be found.');
                return;
            }
            
            // Create a copy with new ID and modified name
            const duplicatedTemplate = {
                ...template,
                id: 'temp_' + Date.now(),
                name: template.name + ' (Copy)',
                created_at: new Date().toISOString()
            };
            
            currentTemplates.push(duplicatedTemplate);
            
            showSuccess('Template Duplicated', 'A copy of "' + template.name + '" has been created successfully.');
            refreshTemplatesDisplay();
        }
        
        function loadTemplatesFromDatabase() {
            console.log('📚 Loading templates from database...');
            
            // Initialize with some default templates for demonstration
            currentTemplates = [
                {
                    id: 'default_weekly',
                    name: 'Standard Weekly Check-in',
                    description: 'Basic weekly progress review covering key metrics',
                    type: 'weekly',
                    metrics: ['weight', 'macros', 'workouts', 'notes'],
                    created_at: new Date().toISOString(),
                    is_default: true
                },
                {
                    id: 'default_monthly',
                    name: 'Comprehensive Monthly Report',
                    description: 'Detailed monthly assessment including all metrics',
                    type: 'monthly',
                    metrics: ['weight', 'macros', 'workouts', 'sleep', 'energy', 'notes'],
                    created_at: new Date().toISOString(),
                    is_default: true
                }
            ];
            
            console.log('✅ Loaded', currentTemplates.length, 'templates');
            refreshTemplatesDisplay();
        }
        
        async function loadTemplatesForDropdown() {
            console.log('📋 Loading templates for report creation dropdown...');
            
            const templateSelect = document.getElementById('report-template-select');
            if (!templateSelect) {
                console.warn('⚠️ Template select dropdown not found');
                return;
            }
            
            // Show loading state
            templateSelect.innerHTML = '<option value="">Loading templates...</option>';
            
            try {
                // Ensure templates are loaded
                if (!currentTemplates || currentTemplates.length === 0) {
                    await loadReportTemplates();
                }
                
                if (!currentTemplates || currentTemplates.length === 0) {
                    templateSelect.innerHTML = '<option value="">No templates available</option>';
                    return;
                }
                
                templateSelect.innerHTML = '<option value="">Choose a template (optional)...</option>' +
                    currentTemplates.map(function(template) {
                        return '<option value="' + template.id + '">' + escapeHtml(template.template_name) + '</option>';
                    }).join('');
                    
            } catch (error) {
                console.error('❌ Error loading templates for dropdown:', error);
                templateSelect.innerHTML = '<option value="">Error loading templates</option>';
            }
        }
        

        
        function viewReportDetails(reportId) {
            console.log('👀 Viewing report details for:', reportId);
            showInfo('Feature Coming Soon', 'Report details view will be available in the next update.');
        }
        
        function downloadReport(reportId) {
            console.log('📥 Downloading report:', reportId);
            showInfo('Feature Coming Soon', 'Report download will be available in the next update.');
        }
        
        function shareReport(reportId) {
            console.log('🔗 Sharing report:', reportId);
            showInfo('Feature Coming Soon', 'Report sharing will be available in the next update.');
        }
        

        
        // Utility Functions
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        function formatDate(date) {
            if (!date) return 'Unknown';
            return new Date(date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        function setupReportTypeListeners() {
            const radioButtons = document.querySelectorAll('input[name="report-type"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    const customRange = document.getElementById('custom-date-range');
                    if (this.value === 'custom') {
                        if (customRange) customRange.classList.remove('hidden');
                        // Set default dates
                        const today = new Date();
                        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                        const fromDate = document.getElementById('report-date-from');
                        const toDate = document.getElementById('report-date-to');
                        if (fromDate) fromDate.value = weekAgo.toISOString().split('T')[0];
                        if (toDate) toDate.value = today.toISOString().split('T')[0];
                    } else {
                        if (customRange) customRange.classList.add('hidden');
                    }
                    updateReportTitle();
                });
            });
            
            // Listen for client selection changes
            const clientSelect = document.getElementById('report-client-select');
            if (clientSelect) {
                clientSelect.addEventListener('change', updateReportTitle);
            }
        }
        
        function updateReportTitle() {
            const clientSelect = document.getElementById('report-client-select');
            const reportType = document.querySelector('input[name="report-type"]:checked');
            const titleInput = document.getElementById('report-title');
            
            if (clientSelect && clientSelect.value && reportType && titleInput) {
                const clientName = clientSelect.selectedOptions[0].text;
                const typeLabel = {
                    'weekly': 'Weekly',
                    'monthly': 'Monthly',
                    'custom': 'Custom'
                }[reportType.value] || 'Progress';
                
                const today = new Date().toLocaleDateString();
                titleInput.value = typeLabel + ' Progress Report - ' + clientName + ' - ' + today;
            }
        }
        

        
        // Load My Reports (SIMPLIFIED)
        async function loadMyReports() {
            try {
                let coachInfo = window.coachAuthWrapper.getCurrentCoach();
                if (!coachInfo.isAuthenticated) return;

                const { data: reports, error } = await window.supabaseClient
                    .from('progress_reports')
                    .select('*')
                    .eq('coach_email', coachInfo.email)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                currentReports = reports;
                renderReportsList(reports);

            } catch (error) {
                console.error('❌ Error loading reports:', error);
                showError('Error loading reports', 'Failed to load reports');
            }
        }

        // Render Reports List


        // Load Report Templates
        async function loadReportTemplates() {
            try {
                let coachInfo = window.coachAuthWrapper.getCurrentCoach();
                if (!coachInfo.isAuthenticated) return;

                // Load system templates and user templates
                const { data: templates, error } = await window.supabaseClient
                    .from('report_templates')
                    .select('*')
                    .or(`is_system_template.eq.true,coach_email.eq.${coachInfo.email}`)
                    .eq('is_active', true)
                    .order('is_system_template', { ascending: false });

                if (error) throw error;

                currentTemplates = templates;
                renderTemplatesList(templates);

            } catch (error) {
                console.error('❌ Error loading templates:', error);
                showError('Error loading templates', 'Failed to load report templates');
            }
        }

        // Render Templates List
        function renderTemplatesList(templates) {
            const templatesContainer = document.getElementById('templates-grid');
            
            templatesContainer.innerHTML = templates.map(function(template) {
                return '<div class="template-card" onclick="selectTemplate(\'' + template.id + '\', this)">' +
                       '<div class="chart-preview"><i class="fas fa-chart-bar text-4xl"></i></div>' +
                       '<h3 class="font-medium text-gray-900 mb-2">' + escapeHtml(template.template_name) + '</h3>' +
                       '<p class="text-sm text-gray-600 mb-3">' + escapeHtml(template.template_description || 'No description') + '</p>' +
                       '<div class="flex items-center justify-between">' +
                       '<span class="text-xs px-2 py-1 bg-gray-100 rounded-full">' +
                       (template.is_system_template ? 'System' : 'Custom') + '</span>' +
                       '<span class="text-xs text-gray-500">Used ' + template.usage_count + ' times</span>' +
                       '</div></div>';
            }).join('');
        }

        // Select Template Function
        function selectTemplate(templateId, element) {
            console.log('📋 Template selected:', templateId);
            
            // Find the template in currentTemplates
            const template = currentTemplates.find(t => t.id === templateId);
            if (!template) {
                console.error('❌ Template not found:', templateId);
                showError('Template not found', 'The selected template could not be found.');
                return;
            }

            // Store selected template
            selectedReportId = templateId;
            
            // Update UI to show selection - remove selection from all cards
            document.querySelectorAll('.template-card').forEach(function(card) {
                card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
                card.classList.add('bg-white');
            });
            
            // Highlight selected template using the passed element
            if (element) {
                element.classList.remove('bg-white');
                element.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
            }
            
            // Show template details
            showSuccess('Template selected', 'Selected: ' + template.template_name);
            
            console.log('✅ Template selected successfully:', template.template_name);
        }

        // Create Report Modal Functions





        function updateReportTitle() {
            const clientSelect = document.getElementById('report-client-select');
            const reportType = document.querySelector('input[name="report-type"]:checked')?.value;
            const titleInput = document.getElementById('report-title');
            
            if (clientSelect.value && reportType) {
                const clientName = clientSelect.selectedOptions[0].text;
                const typeLabel = {
                    'weekly': 'Weekly',
                    'monthly': 'Monthly',
                    'custom': 'Custom'
                }[reportType];
                
                const today = new Date().toLocaleDateString();
                titleInput.value = typeLabel + ' Progress Report - ' + clientName + ' - ' + today;
            }
        }



        // Create Progress Report
        async function createProgressReport(event) {
            event.preventDefault();
            
            try {
                let coachInfo = window.coachAuthWrapper.getCurrentCoach();
                if (!coachInfo.isAuthenticated) {
                    throw new Error('Not authenticated');
                }

                const formData = new FormData(event.target);
                
                // Safely get form elements with null checks
                const clientEmailElement = document.getElementById('report-client-select');
                const reportTypeElement = document.querySelector('input[name="report-type"]:checked');
                const templateIdElement = document.getElementById('report-template-select');
                const reportTitleElement = document.getElementById('report-title');
                
                if (!clientEmailElement || !reportTypeElement || !reportTitleElement) {
                    throw new Error('Form elements not found. Please refresh and try again.');
                }
                
                const clientEmail = clientEmailElement.value;
                const reportType = reportTypeElement.value;
                const templateId = templateIdElement ? templateIdElement.value : null;
                const reportTitle = reportTitleElement.value;

                if (!clientEmail || !reportType || !reportTitle) {
                    throw new Error('Please fill in all required fields');
                }

                // Calculate date range
                let dateFrom, dateTo;
                const today = new Date();
                
                if (reportType === 'weekly') {
                    dateTo = today.toISOString().split('T')[0];
                    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    dateFrom = weekAgo.toISOString().split('T')[0];
                } else if (reportType === 'monthly') {
                    dateTo = today.toISOString().split('T')[0];
                    const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                    dateFrom = monthAgo.toISOString().split('T')[0];
                } else {
                    const fromElement = document.getElementById('report-date-from');
                    const toElement = document.getElementById('report-date-to');
                    
                    if (!fromElement || !toElement) {
                        throw new Error('Date selection elements not found');
                    }
                    
                    dateFrom = fromElement.value;
                    dateTo = toElement.value;
                }

                if (!dateFrom || !dateTo) {
                    throw new Error('Please select valid dates');
                }

                // Find client info
                const client = clientsData.find(c => (c.user_email || c.email) === clientEmail);
                if (!client) {
                    throw new Error('Client not found');
                }

                showInfo('Generating progress report...', 'Report Generation');

                // Get client name for privacy
                const clientName = client.user_name || client.display_name || client.email?.split('@')[0] || 'Unknown Client';

                // Create report record
                const { data: report, error: reportError } = await window.supabaseClient
                    .from('progress_reports')
                    .insert([{
                        coach_user_id: coachInfo.id,
                        coach_email: coachInfo.email,
                        client_user_id: client.user_id || null,
                        client_email: clientEmail,
                        client_name: clientName,
                        client_anon_profile_id: client.anon_profile_id || null,
                        report_type: reportType,
                        report_title: reportTitle,
                        date_from: dateFrom,
                        date_to: dateTo,
                        template_id: templateId || null,
                        report_status: 'generating'
                    }])
                    .select()
                    .single();

                if (reportError) throw reportError;

                closeCreateReportModal();
                showSuccess('Report generation started', 'Report Created');

                // Generate the actual report
                await generateReportContent(report);
                
                // Refresh reports list
                loadMyReports();

            } catch (error) {
                console.error('❌ Error creating report:', error);
                showError(error.message, 'Report Creation Failed');
            }
        }

        // Generate Report Content
        async function generateReportContent(report) {
            try {
                console.log('📊 Generating report content for:', report.id);

                // Get client metrics using the backend function
                const { data: metrics, error: metricsError } = await window.supabaseClient
                    .rpc('calculate_client_report_metrics', {
                        p_client_user_id: report.client_user_id,
                        p_client_email: report.client_email,
                        p_client_anon_profile_id: report.client_anon_profile_id,
                        p_date_from: report.date_from,
                        p_date_to: report.date_to
                    });

                if (metricsError) throw metricsError;

                // Generate PDF report
                const pdfBlob = await generatePDFReport(report, metrics);
                
                // For demo purposes, we'll store the report data in the database
                // In production, you'd upload the PDF to storage and get a URL
                const { error: updateError } = await window.supabaseClient
                    .from('progress_reports')
                    .update({
                        report_status: 'completed',
                        report_data: metrics,
                        generated_at: new Date().toISOString(),
                        generation_time_ms: Date.now() - new Date(report.created_at).getTime()
                    })
                    .eq('id', report.id);

                if (updateError) throw updateError;

                showSuccess('Report generated successfully!', 'Report Complete');

            } catch (error) {
                console.error('❌ Error generating report content:', error);
                
                // Update report status to failed
                await window.supabaseClient
                    .from('progress_reports')
                    .update({
                        report_status: 'failed',
                        error_message: error.message
                    })
                    .eq('id', report.id);
                
                showError('Report generation failed', 'Generation Failed');
            }
        }

        // Generate PDF Report
        // Helper function to add logo to PDF
        async function addLogoToPDF(doc, x, y) {
            try {
                const coachInfo = window.coachAuthWrapper.getCurrentCoach();
                
                // Check if coach has custom logo
                const { data: logo } = await window.supabaseClient
                    .from('coach_logos')
                    .select('logo_url')
                    .eq('coach_user_id', coachInfo.id)
                    .eq('is_active', true)
                    .single();
                    
                if (logo && logo.logo_url) {
                    // Load and add custom logo
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    return new Promise((resolve) => {
                        img.onload = function() {
                            // Calculate aspect ratio and fit to max 30x15mm
                            const maxWidth = 30;
                            const maxHeight = 15;
                            let width = maxWidth;
                            let height = (this.height / this.width) * maxWidth;
                            
                            if (height > maxHeight) {
                                height = maxHeight;
                                width = (this.width / this.height) * maxHeight;
                            }
                            
                            doc.addImage(this, 'JPEG', x, y, width, height);
                            resolve();
                        };
                        
                        img.onerror = function() {
                            // Fallback to default logo
                            addDefaultLogo(doc, x, y);
                            resolve();
                        };
                        
                        img.src = logo.logo_url;
                    });
                } else {
                    // Use default MacroTrack Pro logo
                    addDefaultLogo(doc, x, y);
                }
            } catch (error) {
                console.log('Error loading custom logo, using default:', error);
                addDefaultLogo(doc, x, y);
            }
        }
        
        function addDefaultLogo(doc, x, y) {
            const primaryBlue = [53, 104, 255];
            // Default logo (blue circle with MT)
            doc.setFillColor(primaryBlue[0], primaryBlue[1], primaryBlue[2]);
            doc.circle(x + 10, y + 8, 6, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.text('MT', x + 7, y + 10);
        }
        
        async function generatePDFReport(report, metrics) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4'); // A4 portrait

            try {
                // Brand colors
                const primaryBlue = [53, 104, 255]; // #3568FF
                const lightBlue = [232, 238, 255]; // #E8EEFF
                const lightGray = [244, 244, 244]; // #F4F4F4
                const darkGray = [107, 114, 128];
                const black = [0, 0, 0];
                
                // Page margins
                const margin = 20;
                const pageWidth = 210;
                const contentWidth = pageWidth - (margin * 2);
                let currentY = margin;
                
                // Helper function to draw rounded rectangle
                function drawRoundedRect(x, y, width, height, radius, fillColor) {
                    if (fillColor) {
                        doc.setFillColor(fillColor[0], fillColor[1], fillColor[2]);
                    }
                    doc.roundedRect(x, y, width, height, radius, radius, 'F');
                }
                
                // 1. HEADER SECTION
                // Custom Logo or Default
                await addLogoToPDF(doc, margin, currentY);
                
                // Title (centered)
                doc.setTextColor(black[0], black[1], black[2]);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('Daily Progress Report', pageWidth / 2, currentY + 10, { align: 'center' });
                
                // Date and client (right-aligned)
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                const reportDate = new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                doc.text(reportDate, pageWidth - margin, currentY + 6, { align: 'right' });
                doc.text(report.client_name || report.client_email || 'Client', pageWidth - margin, currentY + 12, { align: 'right' });
                
                currentY += 25;
                
                // 2. SUMMARY CARDS ROW
                const cardWidth = (contentWidth - 15) / 4; // 4 cards with 5mm spacing
                const cardHeight = 20;
                
                // Extract metrics for summary cards
                const totalCalories = metrics?.macro_totals?.consumed?.calories || 0;
                const adherencePercent = metrics?.adherence?.average_score || 0;
                const loggedMeals = metrics?.meal_summary?.total_meals || 0;
                const activeGoal = 'Weight Loss'; // Default or from data
                
                const summaryData = [
                    { title: 'Calories Consumed', value: Math.round(totalCalories) },
                    { title: 'Adherence', value: Math.round(adherencePercent) + '%' },
                    { title: 'Logged Meals', value: loggedMeals },
                    { title: 'Active Goal', value: activeGoal }
                ];
                
                summaryData.forEach((card, index) => {
                    const cardX = margin + (index * (cardWidth + 5));
                    
                    // Draw card background
                    drawRoundedRect(cardX, currentY, cardWidth, cardHeight, 3, lightBlue);
                    
                    // Card content
                    doc.setTextColor(primaryBlue[0], primaryBlue[1], primaryBlue[2]);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text(card.value.toString(), cardX + cardWidth/2, currentY + 8, { align: 'center' });
                    
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                    doc.text(card.title, cardX + cardWidth/2, currentY + 14, { align: 'center' });
                });
                
                currentY += 30;
                
                // 3. MACRO BREAKDOWN SECTION
                doc.setTextColor(black[0], black[1], black[2]);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Macro Breakdown', margin, currentY);
                currentY += 10;
                
                const macros = [
                    { name: 'Calories', consumed: totalCalories, target: metrics?.macro_totals?.targets?.calories || 2000 },
                    { name: 'Protein', consumed: metrics?.macro_totals?.consumed?.protein || 0, target: metrics?.macro_totals?.targets?.protein || 150, unit: 'g' },
                    { name: 'Carbs', consumed: metrics?.macro_totals?.consumed?.carbs || 0, target: metrics?.macro_totals?.targets?.carbs || 200, unit: 'g' },
                    { name: 'Fats', consumed: metrics?.macro_totals?.consumed?.fat || 0, target: metrics?.macro_totals?.targets?.fat || 65, unit: 'g' }
                ];
                
                macros.forEach((macro, index) => {
                    const barY = currentY + (index * 12);
                    const barWidth = 120;
                    const barHeight = 6;
                    const barX = margin + 50;
                    
                    // Macro name
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(black[0], black[1], black[2]);
                    doc.text(macro.name, margin, barY + 4);
                    
                    // Target bar (background)
                    doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
                    doc.rect(barX, barY, barWidth, barHeight, 'F');
                    
                    // Consumed bar (foreground)
                    const consumedWidth = Math.min((macro.consumed / macro.target) * barWidth, barWidth);
                    doc.setFillColor(primaryBlue[0], primaryBlue[1], primaryBlue[2]);
                    doc.rect(barX, barY, consumedWidth, barHeight, 'F');
                    
                    // Values
                    const unit = macro.unit || '';
                    doc.setFontSize(9);
                    doc.text(Math.round(macro.consumed) + unit + ' / ' + Math.round(macro.target) + unit, barX + barWidth + 5, barY + 4);
                });
                
                currentY += 60;
                
                // 4. MEAL SUMMARY TABLE
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(black[0], black[1], black[2]);
                doc.text('Meal Summary', margin, currentY);
                currentY += 10;
                
                // Table headers
                const colWidths = [35, 60, 25, 20, 20, 20];
                const headers = ['Meal', 'Foods', 'Cal', 'Pro', 'Carbs', 'Fat'];
                let tableX = margin;
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                headers.forEach((header, index) => {
                    doc.text(header, tableX, currentY);
                    tableX += colWidths[index];
                });
                
                currentY += 8;
                
                // Sample meal data (replace with actual data)
                const meals = [
                    { name: 'Breakfast', foods: 'Oatmeal, Banana', calories: 320, protein: 12, carbs: 58, fat: 6 },
                    { name: 'Lunch', foods: 'Chicken Salad', calories: 450, protein: 35, carbs: 20, fat: 22 },
                    { name: 'Dinner', foods: 'Salmon, Rice, Vegetables', calories: 580, protein: 42, carbs: 45, fat: 18 },
                    { name: 'Snacks', foods: 'Greek Yogurt, Nuts', calories: 240, protein: 15, carbs: 12, fat: 16 }
                ];
                
                doc.setFont('helvetica', 'normal');
                meals.forEach(meal => {
                    tableX = margin;
                    doc.text(meal.name, tableX, currentY);
                    tableX += colWidths[0];
                    doc.text(meal.foods, tableX, currentY);
                    tableX += colWidths[1];
                    doc.text(meal.calories.toString(), tableX, currentY);
                    tableX += colWidths[2];
                    doc.text(meal.protein + 'g', tableX, currentY);
                    tableX += colWidths[3];
                    doc.text(meal.carbs + 'g', tableX, currentY);
                    tableX += colWidths[4];
                    doc.text(meal.fat + 'g', tableX, currentY);
                    currentY += 6;
                });
                
                // Total row
                currentY += 2;
                doc.setDrawColor(darkGray[0], darkGray[1], darkGray[2]);
                doc.line(margin, currentY - 1, margin + contentWidth, currentY - 1);
                
                doc.setFont('helvetica', 'bold');
                tableX = margin;
                doc.text('TOTAL', tableX, currentY + 4);
                tableX += colWidths[0] + colWidths[1];
                doc.text('1590', tableX, currentY + 4);
                tableX += colWidths[2];
                doc.text('104g', tableX, currentY + 4);
                tableX += colWidths[3];
                doc.text('135g', tableX, currentY + 4);
                tableX += colWidths[4];
                doc.text('62g', tableX, currentY + 4);
                
                currentY += 20;
                
                // 5. ADHERENCE INSIGHTS
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(black[0], black[1], black[2]);
                doc.text('Adherence Insights', margin, currentY);
                currentY += 8;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                const insights = 'Great progress today! Your protein intake was excellent at 104g (104% of target). ' +
                                'Calorie adherence was strong at 80%. Consider adding more complex carbs to meet your carb targets.';
                const splitInsights = doc.splitTextToSize(insights, contentWidth);
                doc.text(splitInsights, margin, currentY);
                
                currentY += splitInsights.length * 5 + 10;
                
                // 6. COACH NOTES SECTION
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(black[0], black[1], black[2]);
                doc.text('Coach Feedback & Adjustments', margin, currentY);
                currentY += 8;
                
                // Notes box
                doc.setDrawColor(lightGray[0], lightGray[1], lightGray[2]);
                doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
                doc.rect(margin, currentY, contentWidth, 20, 'FD');
                
                doc.setFontSize(9);
                doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                doc.text('Coach notes and recommendations will be added here...', margin + 5, currentY + 8);
                
                currentY += 30;
                
                // 7. FOOTER
                // Blue line
                doc.setDrawColor(primaryBlue[0], primaryBlue[1], primaryBlue[2]);
                doc.setLineWidth(0.5);
                doc.line(margin, 270, pageWidth - margin, 270);
                
                // Footer text
                doc.setFontSize(8);
                doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                doc.setFont('helvetica', 'normal');
                const footerText = 'Generated by MacroTrack Pro | ' + new Date().toLocaleString();
                doc.text(footerText, pageWidth / 2, 275, { align: 'center' });

                return doc.output('blob');

            } catch (error) {
                console.error('❌ Error generating PDF:', error);
                throw error;
            }
        }

        // View Report Details
        async function viewReportDetails(reportId) {
            try {
                const report = currentReports.find(r => r.id === reportId);
                if (!report) {
                    throw new Error('Report not found');
                }

                selectedReportId = reportId;
                
                // Update modal content
                document.getElementById('report-details-title').textContent = report.report_title;
                document.getElementById('report-details-subtitle').textContent = 
                    report.client_email + ' • ' + report.date_from + ' to ' + report.date_to;

                // Generate report preview
                const previewHtml = await generateReportPreview(report);
                document.getElementById('report-details-content').innerHTML = previewHtml;

                // Show/hide action buttons based on status
                const downloadBtn = document.getElementById('download-report-btn');
                const shareBtn = document.getElementById('share-report-btn');
                
                if (report.report_status === 'completed') {
                    downloadBtn.classList.remove('hidden');
                    shareBtn.classList.remove('hidden');
                } else {
                    downloadBtn.classList.add('hidden');
                    shareBtn.classList.add('hidden');
                }

                document.getElementById('report-details-modal').classList.remove('hidden');

            } catch (error) {
                console.error('❌ Error viewing report details:', error);
                showError('Error loading report details', 'Failed to load report details');
            }
        }

        function closeReportDetailsModal() {
            document.getElementById('report-details-modal').classList.add('hidden');
            selectedReportId = null;
        }

        // Generate Report Preview HTML (Simplified)
        async function generateReportPreview(report) {
            // Simplified version to avoid template literal issues
            return '<div class="p-8 text-center"><p>Report preview will be displayed here</p></div>';
        }
        
        // Generate Report Preview HTML (Complex - REMOVED DUE TO SYNTAX ISSUES)
        /* REMOVED FUNCTION TO FIX SYNTAX ERROR
        async function generateReportPreview_DISABLED(report) {
            if (report.report_status !== 'completed' || !report.report_data) {
                return `
                    <div class="text-center py-12">
                        <div class="inline-block p-3 bg-gray-100 rounded-full mb-4">
                            <i class="fas fa-${report.report_status === 'generating' ? 'spinner fa-spin' : 
                                              report.report_status === 'failed' ? 'exclamation-triangle' : 'file-alt'} text-2xl text-gray-400"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">
                            ${report.report_status === 'generating' ? 'Generating Report...' : 
                              report.report_status === 'failed' ? 'Generation Failed' : 'Report Not Available'}
                        </h3>
                        <p class="text-gray-600">
                            ${report.report_status === 'generating' ? 'Please wait while we process your report.' : 
                              report.report_status === 'failed' ? (report.error_message || 'An error occurred during generation.') : 'Report content is not available.'}
                        </p>
                    </div>
                `;
            }

            const metrics = report.report_data;
            
            return \`
                <div class="space-y-6">
                    <!-- Report Summary -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Report Summary</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600">${metrics.period?.total_days || 0}</div>
                                <div class="text-sm text-gray-600">Total Days</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600">${metrics.adherence?.days_logged || 0}</div>
                                <div class="text-sm text-gray-600">Days Logged</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-purple-600">${metrics.adherence?.days_on_track || 0}</div>
                                <div class="text-sm text-gray-600">Days On Track</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-orange-600">${Math.round(metrics.adherence?.average_score || 0)}%</div>
                                <div class="text-sm text-gray-600">Avg Adherence</div>
                            </div>
                        </div>
                    </div>

                    <!-- Macro Analysis -->
                    ${metrics.macro_totals ? `
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Macro Analysis</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="text-center p-4 bg-gray-50 rounded-lg">
                                    <div class="text-lg font-semibold text-gray-900">${Math.round(metrics.macro_totals.consumed?.calories || 0)}</div>
                                    <div class="text-sm text-gray-600">Calories Consumed</div>
                                    <div class="text-xs text-gray-500">Target: ${Math.round(metrics.macro_totals.targets?.calories || 0)}</div>
                                </div>
                                <div class="text-center p-4 bg-gray-50 rounded-lg">
                                    <div class="text-lg font-semibold text-gray-900">${Math.round(metrics.macro_totals.consumed?.protein || 0)}g</div>
                                    <div class="text-sm text-gray-600">Protein</div>
                                    <div class="text-xs text-gray-500">Target: ${Math.round(metrics.macro_totals.targets?.protein || 0)}g</div>
                                </div>
                                <div class="text-center p-4 bg-gray-50 rounded-lg">
                                    <div class="text-lg font-semibold text-gray-900">${Math.round(metrics.macro_totals.consumed?.carbs || 0)}g</div>
                                    <div class="text-sm text-gray-600">Carbs</div>
                                    <div class="text-xs text-gray-500">Target: ${Math.round(metrics.macro_totals.targets?.carbs || 0)}g</div>
                                </div>
                                <div class="text-center p-4 bg-gray-50 rounded-lg">
                                    <div class="text-lg font-semibold text-gray-900">${Math.round(metrics.macro_totals.consumed?.fat || 0)}g</div>
                                    <div class="text-sm text-gray-600">Fat</div>
                                    <div class="text-xs text-gray-500">Target: ${Math.round(metrics.macro_totals.targets?.fat || 0)}g</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Daily Breakdown Chart Area -->
                    <div class="bg-white rounded-lg border border-gray-200 p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Daily Progress</h3>
                        <div id="daily-progress-chart" class="h-64 flex items-center justify-center bg-gray-50 rounded-lg">
                            <div class="text-center text-gray-500">
                                <i class="fas fa-chart-line text-3xl mb-2"></i>
                                <p>Chart visualization would appear here</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } // END OF REMOVED FUNCTION */

        // Download Report
        async function downloadReport(reportId = null) {
            try {
                const id = reportId || selectedReportId;
                if (!id) return;

                const report = currentReports.find(r => r.id === id);
                if (!report) {
                    throw new Error('Report not found');
                }

                if (report.report_status !== 'completed') {
                    throw new Error('Report is not ready for download');
                }

                // Generate fresh PDF
                const pdfBlob = await generatePDFReport(report, report.report_data);
                
                // Download the PDF
                const url = window.URL.createObjectURL(pdfBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = report.report_title + '.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                showSuccess('Report downloaded successfully', 'Report file downloaded');

            } catch (error) {
                console.error('❌ Error downloading report:', error);
                showError('Operation error', error.message);
            }
        }

        // Share Report Functions
        function showShareReportModal(reportId = null) {
            selectedReportId = reportId || selectedReportId;
            document.getElementById('share-report-modal').classList.remove('hidden');
        }

        function closeShareReportModal() {
            document.getElementById('share-report-modal').classList.add('hidden');
            document.getElementById('share-report-form').reset();
        }

        async function shareReport(event) {
            event.preventDefault();
            
            try {
                if (!selectedReportId) {
                    throw new Error('No report selected');
                }

                let coachInfo = window.coachAuthWrapper.getCurrentCoach();
                const email = document.getElementById('share-email').value;
                const canDownload = document.getElementById('share-download-allowed').checked;
                const expirationHours = document.getElementById('share-expiration').value;

                if (!email) {
                    throw new Error('Email is required');
                }

                // Generate secure share token
                const shareToken = generateSecureShareToken();

                // Calculate expiration
                let expiresAt = null;
                if (expirationHours) {
                    const expiration = new Date();
                    expiration.setHours(expiration.getHours() + parseInt(expirationHours));
                    expiresAt = expiration.toISOString();
                }

                // Create share record
                const { data: shareRecord, error } = await window.supabaseClient
                    .from('report_shares')
                    .insert([{
                        report_id: selectedReportId,
                        shared_with_email: email,
                        shared_by_coach_email: coachInfo.email,
                        share_token: shareToken,
                        can_download: canDownload,
                        expires_at: expiresAt,
                        is_active: true,
                        access_count: 0
                    }])
                    .select()
                    .single();

                if (error) throw error;

                // Get report details for email
                const { data: reportDetails, error: reportError } = await window.supabaseClient
                    .from('progress_reports')
                    .select('report_title, client_name, created_at')
                    .eq('id', selectedReportId)
                    .single();

                // Send email notification
                try {
                    await sendReportShareEmail(email, shareToken, reportDetails, coachInfo, expiresAt);
                    showSuccess('Report shared successfully', `Report shared with ${email}. Email notification sent.`);
                } catch (emailError) {
                    console.error('Email sending failed:', emailError);
                    showSuccess('Report shared successfully', `Report shared with ${email}, but email notification failed.`);
                }

                closeShareReportModal();
                
                // Refresh shared reports if we're on that tab
                if (!document.getElementById('shared-content').classList.contains('hidden')) {
                    loadSharedReports();
                }

            } catch (error) {
                console.error('❌ Error sharing report:', error);
                showError('Operation error', error.message);
            }
        }

        // Load Shared Reports
        async function loadSharedReports() {
            try {
                let coachInfo = window.coachAuthWrapper.getCurrentCoach();
                if (!coachInfo.isAuthenticated) return;

                const { data: shares, error } = await window.supabaseClient
                    .from('report_shares')
                    .select('*, progress_reports!inner(report_title,client_email,date_from,date_to,report_status)')
                    .eq('shared_by_coach_email', coachInfo.email)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                currentSharedReports = shares;
                renderSharedReportsList(shares);

            } catch (error) {
                console.error('❌ Error loading shared reports:', error);
                showError('Error loading shared reports', 'Failed to load shared reports');
            }
        }



        // Utility Functions


        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        async function deleteReport(reportId) {
            if (!confirm('Are you sure you want to delete this report?')) return;

            try {
                const { error } = await window.supabaseClient
                    .from('progress_reports')
                    .delete()
                    .eq('id', reportId);

                if (error) throw error;

                showSuccess('Report deleted successfully', 'Report has been deleted');
                loadMyReports();

            } catch (error) {
                console.error('❌ Error deleting report:', error);
                showError('Error deleting report', 'Failed to delete report');
            }
        }

        async function deleteShare(shareId) {
            if (!confirm('Are you sure you want to revoke this share?')) return;

            try {
                // Soft delete by setting is_active to false instead of hard delete
                const { error } = await window.supabaseClient
                    .from('report_shares')
                    .update({ is_active: false, revoked_at: new Date().toISOString() })
                    .eq('id', shareId);

                if (error) throw error;

                showSuccess('Share revoked successfully', 'Report share has been revoked');
                loadSharedReports();

            } catch (error) {
                console.error('❌ Error deleting share:', error);
                showError('Error revoking share', 'Failed to revoke share');
            }
        }
        
        // Revoke Report Share (alias for deleteShare)
        async function revokeReportShare(shareId) {
            await deleteShare(shareId);
        }

        // Email sending function for report sharing
        async function sendReportShareEmail(recipientEmail, shareToken, reportDetails, coachInfo, expiresAt) {
            try {
                // EmailJS configuration (new account for report sharing)
                const serviceId = 'service_ryzwjpd';
                const templateId = 'template_xehiuzj';
                const publicKey = 'rRXKzvLvyv47bhWrz';

                const shareUrl = window.location.origin + '/shared-report.html?token=' + shareToken;
                const expirationDate = expiresAt ? new Date(expiresAt).toLocaleDateString() : 'Never';
                
                const templateParams = {
                    to_email: recipientEmail,
                    share_url: shareUrl,
                    report_title: reportDetails?.report_title || 'Progress Report',
                    client_name: reportDetails?.client_name || 'Client',
                    coach_email: coachInfo.email,
                    expiration_date: expirationDate,
                    report_date: reportDetails?.created_at ? new Date(reportDetails.created_at).toLocaleDateString() : 'Unknown'
                };

                // Load EmailJS library if not already loaded
                if (!window.emailjs) {
                    await loadEmailJSLibrary();
                }

                console.log('📧 Sending report share email to:', recipientEmail);
                const response = await window.emailjs.send(serviceId, templateId, templateParams, publicKey);
                console.log('✅ Report share email sent successfully');
                return response;
            } catch (error) {
                console.error('❌ Failed to send report share email:', error);
                throw error;
            }
        }

        // Load EmailJS library dynamically
        function loadEmailJSLibrary() {
            return new Promise((resolve, reject) => {
                if (window.emailjs) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // Generate secure share token
        function generateSecureShareToken() {
            // Create a cryptographically secure token
            const timestamp = Date.now().toString(36);
            const randomPart1 = Math.random().toString(36).substr(2, 12);
            const randomPart2 = Math.random().toString(36).substr(2, 12);
            const randomPart3 = Math.random().toString(36).substr(2, 8);
            
            return `share_${timestamp}_${randomPart1}_${randomPart2}_${randomPart3}`;
        }
        
        // Logo Management Functions
        async function initializeLogoFeatures() {
            try {
                // Check if coach has Pro or Elite plan
                const coachInfo = window.coachAuthWrapper.getCurrentCoach();
                if (!coachInfo.isAuthenticated) return;
                
                // Check subscription status (implement based on your subscription system)
                const hasProAccess = await checkProAccess(coachInfo);
                
                if (hasProAccess) {
                    // Show logo upload section
                    const logoSection = document.getElementById('logo-upload-section');
                    if (logoSection) {
                        logoSection.classList.remove('hidden');
                    }
                    
                    // Load existing logo if available
                    await loadCurrentLogo(coachInfo);
                }
            } catch (error) {
                console.error('Error initializing logo features:', error);
            }
        }
        
        async function checkProAccess(coachInfo) {
            // Check if coach has Pro or Elite subscription
            // This should integrate with your existing subscription system
            try {
                const { data: subscription } = await window.supabaseClient
                    .from('coach_subscriptions')
                    .select('plan_type')
                    .eq('coach_email', coachInfo.email)
                    .eq('is_active', true)
                    .single();
                    
                return subscription && ['pro', 'elite'].includes(subscription.plan_type?.toLowerCase());
            } catch (error) {
                console.log('Subscription check failed, assuming basic plan');
                return false; // Default to false if subscription system not set up
            }
        }
        
        async function loadCurrentLogo(coachInfo) {
            try {
                const { data: logo } = await window.supabaseClient
                    .from('coach_logos')
                    .select('*')
                    .eq('coach_user_id', coachInfo.id)
                    .eq('is_active', true)
                    .single();
                    
                if (logo) {
                    const previewDiv = document.getElementById('current-logo-preview');
                    const previewImg = document.getElementById('logo-preview-img');
                    
                    if (previewDiv && previewImg) {
                        previewImg.src = logo.logo_url;
                        previewDiv.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.log('No current logo found');
            }
        }
        
        async function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file
            if (!file.type.startsWith('image/')) {
                showError('Invalid file type', 'Please select an image file (PNG, JPG, etc.)');
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) { // 2MB limit
                showError('File too large', 'Please select an image under 2MB');
                return;
            }
            
            try {
                const coachInfo = window.coachAuthWrapper.getCurrentCoach();
                
                // Upload to Supabase Storage
                const fileName = `coach-logo-${coachInfo.id}-${Date.now()}.${file.name.split('.').pop()}`;
                const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
                    .from('coach-assets')
                    .upload(fileName, file);
                    
                if (uploadError) throw uploadError;
                
                // Get public URL
                const { data: urlData } = window.supabaseClient.storage
                    .from('coach-assets')
                    .getPublicUrl(fileName);
                    
                // Deactivate old logos
                await window.supabaseClient
                    .from('coach_logos')
                    .update({ is_active: false })
                    .eq('coach_user_id', coachInfo.id);
                    
                // Save new logo record
                const { error: dbError } = await window.supabaseClient
                    .from('coach_logos')
                    .insert({
                        coach_user_id: coachInfo.id,
                        coach_email: coachInfo.email,
                        logo_url: urlData.publicUrl,
                        logo_filename: fileName,
                        is_active: true
                    });
                    
                if (dbError) throw dbError;
                
                // Update preview
                const previewDiv = document.getElementById('current-logo-preview');
                const previewImg = document.getElementById('logo-preview-img');
                
                if (previewDiv && previewImg) {
                    previewImg.src = urlData.publicUrl;
                    previewDiv.classList.remove('hidden');
                }
                
                showSuccess('Logo uploaded successfully', 'Your custom logo will appear in all future reports');
                
            } catch (error) {
                console.error('Logo upload failed:', error);
                showError('Upload failed', 'Failed to upload logo: ' + error.message);
            }
            
            // Clear input
            event.target.value = '';
        }
        
        async function removeLogo() {
            try {
                const coachInfo = window.coachAuthWrapper.getCurrentCoach();
                
                // Deactivate current logo
                const { error } = await window.supabaseClient
                    .from('coach_logos')
                    .update({ is_active: false })
                    .eq('coach_user_id', coachInfo.id)
                    .eq('is_active', true);
                    
                if (error) throw error;
                
                // Hide preview
                const previewDiv = document.getElementById('current-logo-preview');
                if (previewDiv) {
                    previewDiv.classList.add('hidden');
                }
                
                showSuccess('Logo removed', 'Default MacroTrack Pro logo will be used in reports');
                
            } catch (error) {
                console.error('Logo removal failed:', error);
                showError('Removal failed', 'Failed to remove logo: ' + error.message);
            }
        }
        
        function copyShareLink(shareToken) {
            // In a real implementation, this would be the actual share URL
            const shareUrl = window.location.origin + '/shared-report.html?token=' + shareToken;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showSuccess('Link Copied!', 'Share link copied to clipboard');
                }).catch((err) => {
                    console.error('Failed to copy to clipboard:', err);
                    showError('Copy Failed', 'Unable to copy link to clipboard');
                });
            } else {
                // Fallback for older browsers
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = shareUrl;
                    document.body.appendChild(textArea);
                    textArea.select();
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    if (successful) {
                        showSuccess('Link Copied!', 'Share link copied to clipboard');
                    } else {
                        showError('Copy Failed', 'Unable to copy link to clipboard');
                    }
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                    showError('Copy Failed', 'Copy to clipboard not supported in this browser');
                }
            }
        }

        function filterReports() {
            const statusFilter = document.getElementById('report-status-filter').value;
            const typeFilter = document.getElementById('report-type-filter').value;
            
            let filteredReports = currentReports;
            
            if (statusFilter) {
                filteredReports = filteredReports.filter(r => r.report_status === statusFilter);
            }
            
            if (typeFilter) {
                filteredReports = filteredReports.filter(r => r.report_type === typeFilter);
            }
            
            renderReportsList(filteredReports);
        }

        // Initialize default tab on load
        document.addEventListener('DOMContentLoaded', function() {
            // Set default section to clients only if not already initialized
            setTimeout(function() {
                if (typeof showSection === 'function' && !window.dashboardInitialized) {
                    console.log('🔄 Setting default section to clients');
                    showSection('clients');
                } else {
                    console.log('⚠️ Skipping default section - dashboard already initialized');
                }
            }, 100); // Small delay to ensure initialization completes
        });
        
        // Add basic Progress Reports functionality
        if (typeof showSection === 'undefined') {
            window.showSection = async function(sectionName) {
                console.log('🔄 Switching to section:', sectionName);
                
                // Prevent multiple rapid tab switches
                if (window.sectionSwitching) {
                    console.log('⚠️ Section switch already in progress, ignoring...');
                    return;
                }
                
                window.sectionSwitching = true;
                
                try {
                    // Update tab states
                    document.querySelectorAll('.tab-button').forEach(function(tab) {
                        tab.classList.remove('active', 'text-blue-600', 'border-blue-500');
                        tab.classList.add('text-gray-500', 'border-transparent');
                    });
                    
                    // Activate current tab
                    const activeTab = document.getElementById(sectionName + '-tab');
                    if (activeTab) {
                        activeTab.classList.add('active', 'text-blue-600', 'border-blue-500');
                        activeTab.classList.remove('text-gray-500', 'border-transparent');
                    }

                    // Show/hide sections
                    document.querySelectorAll('.section-content').forEach(function(section) {
                        section.classList.add('hidden');
                    });
                    
                    const targetSection = document.getElementById(sectionName + '-section');
                    if (targetSection) {
                        targetSection.classList.remove('hidden');
                    }

                    // Load section-specific content
                    if (sectionName === 'reports') {
                        console.log('📊 Loading Progress Reports section...');
                        loadProgressReportsContent();
                    } else if (sectionName === 'clients') {
                        console.log('👥 Switching to Clients section - refreshing client data...');
                        
                        // Check if we need to refresh client data
                        if (!isLoadingDashboard && (!clientsData || clientsData.length === 0)) {
                            console.log('🔄 No client data cached, loading dashboard content...');
                            await loadDashboardContent();
                        } else {
                            console.log('✅ Using cached client data, no refresh needed');
                        }
                        console.log('✅ Client section switch completed');
                    }
                } catch (error) {
                    console.error('❌ Error switching sections:', error);
                    showError('Navigation Error', 'Failed to switch sections');
                } finally {
                    window.sectionSwitching = false;
                }
            };
        }
        
        // Settings Modal Functions
        function openSettingsModal() {
            document.getElementById('settings-modal').classList.remove('hidden');
        }
        
        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }


    </script>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between pb-3">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-cog text-blue-600 mr-2"></i>Coach Settings
                    </h3>
                    <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- Custom Logo Section for Pro/Elite plans -->
                    <div id="logo-upload-section" class="hidden border-b border-gray-200 pb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            <i class="fas fa-image text-blue-600 mr-2"></i>Custom Logo for Reports
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 ml-2">PRO/ELITE</span>
                        </label>
                        <div class="space-y-3">
                            <div id="current-logo-preview" class="hidden p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <img id="logo-preview-img" src="" alt="Current Logo" class="h-12 w-auto border border-gray-300 rounded">
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-gray-900">Current Logo</p>
                                        <p class="text-xs text-gray-500">This logo will appear on all client reports</p>
                                    </div>
                                    <button onclick="removeLogo()" class="text-red-600 text-sm hover:text-red-700 px-3 py-1 border border-red-300 rounded">
                                        <i class="fas fa-trash mr-1"></i>Remove
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-4 border-2 border-dashed border-gray-300 rounded-lg">
                                <div class="flex-1">
                                    <input type="file" id="logo-upload" accept="image/*" class="hidden" onchange="handleLogoUpload(event)">
                                    <button onclick="document.getElementById('logo-upload').click()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                        <i class="fas fa-upload mr-2"></i>Upload New Logo
                                    </button>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-500">PNG, JPG up to 2MB</p>
                                    <p class="text-xs text-gray-500">Recommended: 200x80px</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Other Settings -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Auto-refresh interval</label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option>Every 2 minutes</option>
                            <option>Every 5 minutes</option>
                            <option>Every 10 minutes</option>
                            <option>Disabled</option>
                        </select>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button onclick="closeSettingsModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                            Cancel
                        </button>
                        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>