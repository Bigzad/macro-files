<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Invitation</title>
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Professional Notifications -->
    <script src="professional-notifications.js"></script>
    
    <!-- Custom styles -->
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .input-focus:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            border-color: #6366f1;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="glass-effect rounded-xl p-8 w-full max-w-md shadow-2xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-envelope-open text-white text-2xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-white mb-2">Complete Your Invitation</h1>
            <p class="text-white text-opacity-80">Set up your account to get started</p>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-8 hidden">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-4"></div>
            <p class="text-white text-opacity-80">Validating invitation...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden">
            <div class="bg-red-500 bg-opacity-20 border border-red-400 rounded-lg p-4 mb-6">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-300 mr-3"></i>
                    <div>
                        <h3 class="text-red-200 font-semibold">Invalid Invitation</h3>
                        <p id="errorMessage" class="text-red-300 text-sm mt-1"></p>
                    </div>
                </div>
            </div>
            <div class="text-center">
                <a href="/" class="inline-flex items-center px-4 py-2 bg-white bg-opacity-20 text-white rounded-lg hover:bg-opacity-30 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back to Home
                </a>
            </div>
        </div>

        <!-- Success State -->
        <div id="successState" class="hidden">
            <div class="bg-green-500 bg-opacity-20 border border-green-400 rounded-lg p-4 mb-6">
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-300 mr-3"></i>
                    <div>
                        <h3 class="text-green-200 font-semibold">Account Created Successfully!</h3>
                        <p class="text-green-300 text-sm mt-1">Redirecting to your dashboard...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invitation Form -->
        <form id="inviteForm" class="space-y-6">
            <!-- Invitation Type Indicator -->
            <div id="invitationTypeIndicator" class="hidden mb-4 p-3 bg-blue-600 bg-opacity-30 border border-blue-500 border-opacity-50 rounded-lg">
                <div class="flex items-center">
                    <i id="invitationTypeIcon" class="fas fa-info-circle text-blue-300 mr-3"></i>
                    <span id="invitationTypeText" class="text-blue-200 text-sm"></span>
                </div>
            </div>
            <!-- Email Field (readonly) -->
            <div>
                <label class="block text-white text-sm font-medium mb-2">
                    <i class="fas fa-envelope mr-2"></i>Email Address
                </label>
                <input 
                    type="email" 
                    id="email" 
                    name="email" 
                    readonly 
                    class="w-full px-4 py-3 bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg text-white placeholder-white placeholder-opacity-60 focus:outline-none input-focus"
                    placeholder="Loading..."
                >
            </div>

            <!-- Full Name Field -->
            <div>
                <label class="block text-white text-sm font-medium mb-2">
                    <i class="fas fa-user mr-2"></i>Full Name
                </label>
                <input 
                    type="text" 
                    id="fullName" 
                    name="fullName" 
                    required 
                    class="w-full px-4 py-3 bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg text-white placeholder-white placeholder-opacity-60 focus:outline-none input-focus"
                    placeholder="Enter your full name"
                >
            </div>

            <!-- Password Field -->
            <div>
                <label class="block text-white text-sm font-medium mb-2">
                    <i class="fas fa-lock mr-2"></i>Password
                </label>
                <div class="relative">
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        required 
                        minlength="6"
                        class="w-full px-4 py-3 pr-12 bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg text-white placeholder-white placeholder-opacity-60 focus:outline-none input-focus"
                        placeholder="Choose a secure password"
                    >
                    <button 
                        type="button" 
                        id="togglePassword" 
                        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-white text-opacity-60 hover:text-opacity-100 focus:outline-none"
                    >
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <p class="text-white text-opacity-60 text-xs mt-1">Minimum 6 characters required</p>
            </div>

            <!-- Submit Button -->
            <button 
                type="submit" 
                id="submitBtn" 
                class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50"
            >
                <span>Complete Setup</span>
                <i class="fas fa-arrow-right"></i>
            </button>
        </form>

        <!-- Footer -->
        <div class="text-center mt-8 pt-6 border-t border-white border-opacity-20">
            <p class="text-white text-opacity-60 text-sm">
                Already have an account? 
                <a href="/" class="text-white hover:text-opacity-80 underline">Sign in here</a>
            </p>
        </div>
    </div>

    <!-- Load Supabase Configuration -->
    <script src="supabase-config.js"></script>
    
    <!-- Invitation Processing Script -->
    <script>
        class InvitationProcessor {
            constructor() {
                this.token = null;
                this.email = null;
                this.supabaseUrl = 'https://xnpsjajyjtczlxciatfy.supabase.co';
                
                // DOM elements
                this.form = document.getElementById('inviteForm');
                this.loadingState = document.getElementById('loadingState');
                this.errorState = document.getElementById('errorState');
                this.successState = document.getElementById('successState');
                this.errorMessage = document.getElementById('errorMessage');
                this.emailInput = document.getElementById('email');
                this.fullNameInput = document.getElementById('fullName');
                this.passwordInput = document.getElementById('password');
                this.submitBtn = document.getElementById('submitBtn');
                this.togglePasswordBtn = document.getElementById('togglePassword');
                
                this.init();
            }
            
            init() {
                this.parseUrlParameters();
                this.setupEventListeners();
                this.validateInvitation();
            }
            
            parseUrlParameters() {
                const urlParams = new URLSearchParams(window.location.search);
                this.token = urlParams.get('token');
                this.code = urlParams.get('code');
                this.email = urlParams.get('email');
                
                console.log('Parsed URL parameters:', { token: this.token, code: this.code, email: this.email });
                
                if (!this.token && !this.code) {
                    this.showError('Missing invitation token or code. Please use the link from your invitation email or enter your invitation code.');
                    return;
                }
                
                // Set email in form if provided (typically with tokens)
                if (this.email) {
                    this.emailInput.value = this.email;
                } else {
                    // Make email field editable if not provided in URL (invitation codes or tokens without email)
                    this.emailInput.removeAttribute('readonly');
                    this.emailInput.placeholder = 'Enter your email address';
                    this.emailInput.required = true;
                }
                
                // Show invitation type indicator
                this.showInvitationType();
            }
            
            setupEventListeners() {
                // Form submission
                this.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.processInvitation();
                });
                
                // Password toggle
                this.togglePasswordBtn.addEventListener('click', () => {
                    const type = this.passwordInput.type === 'password' ? 'text' : 'password';
                    this.passwordInput.type = type;
                    
                    const icon = this.togglePasswordBtn.querySelector('i');
                    icon.className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
                });
                
                // Real-time validation
                this.passwordInput.addEventListener('input', () => {
                    this.validatePasswordStrength();
                });
            }
            
            validatePasswordStrength() {
                const password = this.passwordInput.value;
                const minLength = 6;
                
                if (password.length === 0) return;
                
                // Basic validation - you can enhance this
                const isValid = password.length >= minLength;
                
                this.passwordInput.style.borderColor = isValid 
                    ? 'rgba(34, 197, 94, 0.5)' 
                    : 'rgba(239, 68, 68, 0.5)';
            }
            
            async validateInvitation() {
                if (!this.token && !this.code) return;
                
                this.showLoading();
                
                try {
                    // For initial validation, we'll just check if we have a token or code
                    // The actual validation will happen when processing the invitation
                    console.log('Validating invitation with:', this.token ? 'token' : 'code');
                    this.hideLoading();
                    this.showForm();
                } catch (error) {
                    console.error('Validation error:', error);
                    this.showError('Failed to validate invitation. Please try again.');
                }
            }
            
            async processInvitation() {
                const formData = new FormData(this.form);
                const email = formData.get('email') || this.email;
                const fullName = formData.get('fullName');
                const password = formData.get('password');
                
                // Basic validation
                if (!email || !fullName || !password) {
                    showError('Missing Information', 'Please fill in all required fields.');
                    return;
                }
                
                if (password.length < 6) {
                    showError('Invalid Password', 'Password must be at least 6 characters long.');
                    return;
                }
                
                this.setLoading(true);
                
                try {
                    // Call the unified Edge Function for both invitation types
                    const response = await fetch(`${this.supabaseUrl}/functions/v1/process-invite`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify({
                            token: this.token,
                            code: this.code,
                            email: email,
                            password: password,
                            fullName: fullName,
                            invitationType: this.token ? 'token' : 'code'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        this.showSuccess();
                        
                        // Redirect to dashboard after a short delay
                        setTimeout(() => {
                            window.location.href = '/app.html';
                        }, 2000);
                    } else {
                        throw new Error(result.error || 'Failed to process invitation');
                    }
                    
                } catch (error) {
                    console.error('Processing error:', error);
                    this.showError(error.message || 'Failed to process invitation. Please try again.');
                } finally {
                    this.setLoading(false);
                }
            }
            
            setLoading(isLoading) {
                this.submitBtn.disabled = isLoading;
                if (isLoading) {
                    this.submitBtn.innerHTML = `
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                        Processing...
                    `;
                } else {
                    this.submitBtn.innerHTML = `
                        <span>Complete Setup</span>
                        <i class="fas fa-arrow-right ml-2"></i>
                    `;
                }
            }
            
            showInvitationType() {
                const indicator = document.getElementById('invitationTypeIndicator');
                const icon = document.getElementById('invitationTypeIcon');
                const text = document.getElementById('invitationTypeText');
                
                if (this.token) {
                    icon.className = 'fas fa-envelope text-blue-300 mr-3';
                    text.textContent = 'Using email invitation token - your email may be pre-filled.';
                } else if (this.code) {
                    icon.className = 'fas fa-key text-blue-300 mr-3';
                    text.textContent = 'Using invitation code - please enter your email address.';
                }
                
                if (this.token || this.code) {
                    indicator.classList.remove('hidden');
                }
            }
            
            showLoading() {
                this.form.style.display = 'none';
                this.errorState.classList.add('hidden');
                this.successState.classList.add('hidden');
                this.loadingState.classList.remove('hidden');
            }
            
            hideLoading() {
                this.loadingState.classList.add('hidden');
            }
            
            showForm() {
                this.form.style.display = 'block';
            }
            
            showError(message) {
                this.hideLoading();
                this.form.style.display = 'none';
                this.successState.classList.add('hidden');
                this.errorMessage.textContent = message;
                this.errorState.classList.remove('hidden');
            }
            
            showSuccess() {
                this.hideLoading();
                this.form.style.display = 'none';
                this.errorState.classList.add('hidden');
                this.successState.classList.remove('hidden');
            }
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new InvitationProcessor();
        });
    </script>
</body>
</html>